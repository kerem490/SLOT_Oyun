import wwjs from "whatsapp-web.js";
const { Client, LocalAuth } = wwjs;
import qrcode from "qrcode-terminal";
import fs from "fs";
import path from "path";
import dotenv from "dotenv";
import { Low } from "lowdb";
import { JSONFile } from "lowdb/node";

dotenv.config();

/* ==================== Telefon YardÄ±mcÄ±larÄ± ==================== */
function normPhone(raw) {
  const d = (raw || "").replace(/\D/g, "");
  if (d.startsWith("90") && d.length === 12) return d;       // 90xxxxxxxxxx
  if (d.startsWith("0") && d.length === 11) return "9" + d;  // 0xxxxxxxxxx -> 90xxxxxxxxxx
  if (d.length === 10) return "90" + d;                      // xxxxxxxxxx  -> 90xxxxxxxxxx
  return d;
}
function last10(s) {
  const d = (s || "").replace(/\D/g, "");
  return d.slice(-10);
}

/* ==================== DB Kurulumu ==================== */
const DATA_DIR = process.env.DATA_DIR || "./data";
if (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, { recursive: true });

const dbFile = path.join(DATA_DIR, "players.json");
const adapter = new JSONFile(dbFile);
const db = new Low(adapter, { players: {} });

await (async () => {
  try { await db.read(); }
  catch {
    db.data = { players: {} };
    await db.write();
  }
})();
if (!db.data) db.data = { players: {} };

async function saveDB() {
  await db.write();
}

/* ==================== Ayarlar ==================== */
const STARTING_STACK = parseInt(process.env.STARTING_STACK || "10000", 10);
const MIN_BET        = parseInt(process.env.MIN_BET || "100", 10);
const DAILY_REWARD   = parseInt(process.env.DAILY_REWARD || "2500", 10);
const AUTO_TOPUP     = parseInt(process.env.AUTO_TOPUP || "3000", 10);

// 1 kristal = ÅŸu kadar Ã§ip
const CRYSTAL_TO_CHIP = parseInt(process.env.CRYSTAL_TO_CHIP || "50000", 10);

/* ==== Admin yapÄ±landÄ±rma ==== */
const ADMIN_PIN = (process.env.ADMIN_PIN || "1234").trim();
const ADMIN_PHONES = (process.env.ADMIN_PHONES || process.env.ADMIN_PHONE || "")
  .split(",")
  .map(s => s.trim())
  .filter(Boolean)
  .map(normPhone);

// KalÄ±cÄ± admin dosyasÄ±
const adminsFile = path.join(DATA_DIR, "admins.json");
if (!fs.existsSync(adminsFile)) {
  fs.writeFileSync(adminsFile, JSON.stringify({ phones: [], lids: [] }, null, 2), "utf8");
}
function readAdmins() {
  try { return JSON.parse(fs.readFileSync(adminsFile, "utf8")); }
  catch { return { phones: [], lids: [] }; }
}
function writeAdmins(obj) {
  fs.writeFileSync(adminsFile, JSON.stringify(obj, null, 2), "utf8");
}

/* ==================== Utils ==================== */
function localDateKey(ms = Date.now(), tz = "Europe/Istanbul") {
  return new Date(ms).toLocaleDateString("tr-TR", { timeZone: tz });
}
function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}
function normalizeTR(s) {
  return (s || "")
    .toLowerCase()
    .replace(/Ä±/g, "i")
    .replace(/ÅŸ/g, "s")
    .replace(/Ã§/g, "c")
    .replace(/Ã¶/g, "o")
    .replace(/Ã¼/g, "u")
    .replace(/ÄŸ/g, "g")
    .trim();
}
const SEEN = new Set();
function shouldProcess(msg) {
  const key = msg?.id?._serialized || msg?.id?.id || `${msg.timestamp}:${msg.from}`;
  if (SEEN.has(key)) return false;
  SEEN.add(key);
  setTimeout(() => SEEN.delete(key), 60_000);
  return true;
}

/* ==================== Oyuncu YapÄ±sÄ± ==================== */
function ensureStats(player) {
  if (!player.stats || typeof player.stats !== "object") {
    player.stats = {
      slotGames: 0,
      slotNetWin: 0,
      rouletteGames: 0,
      rouletteWins: 0,
      rouletteLosses: 0,
      bjGames: 0,
      bjWins: 0,
      bjLosses: 0,
      dailyDays: 0,
      huntCount: 0,
      huntProfit: 0,
      boxesOpened: 0
    };
  }
}
function ensureInventory(player) {
  if (!player.inv || typeof player.inv !== "object") {
    player.inv = { boxes: 0 };
  }
}
function ensureCrystals(player) {
  if (typeof player.crystals !== "number") player.crystals = 0;
}

function calculatePlayerLevel(player) {
  ensureStats(player);
  const s = player.stats;
  const totalXp =
    (s.slotGames || 0)     * 2 +
    (s.rouletteGames || 0) * 3 +
    (s.bjGames || 0)       * 3 +
    (s.huntCount || 0)     * 5 +
    (s.boxesOpened || 0)   * 4 +
    (s.dailyDays || 0)     * 10;
  const level = Math.max(1, Math.floor(totalXp / 100) + 1);
  return { level, totalXp };
}

function getPlayer(id, name) {
  if (!db.data.players[id]) {
    db.data.players[id] = {
      name,
      stack: STARTING_STACK,
      lastDaily: "",
      joined: false,
      locked: false,
      stats: undefined,
      inv: undefined,
      crystals: 0
    };
  } else {
    const p = db.data.players[id];
    if (name && !p.name) p.name = name;
    if (typeof p.joined !== "boolean") p.joined = false;
    if (typeof p.locked !== "boolean") p.locked = false;
    if (typeof p.stack !== "number") p.stack = STARTING_STACK;
    if (typeof p.lastDaily !== "string") p.lastDaily = "";
  }
  const p = db.data.players[id];
  ensureStats(p);
  ensureInventory(p);
  ensureCrystals(p);
  return p;
}

/* ==================== Admin kontrol ==================== */
function isAdminCheck(sender) {
  const fileAdmins = readAdmins();
  const phonePool = [
    ...ADMIN_PHONES,
    ...(fileAdmins.phones || []).map(normPhone)
  ];
  if (sender.phoneId) {
    const p = sender.phoneId;
    const p10 = sender.phoneIdLast10;
    if (phonePool.some(ap => ap === p || last10(ap) === p10)) return true;
  }
  if (sender.lid) {
    if ((fileAdmins.lids || []).includes(sender.lid)) return true;
  }
  return false;
}

/* ==================== GÃ¶nderici Ã§Ã¶zÃ¼mleyici ==================== */
async function resolveSender(msg) {
  const authorId = msg.author || "";
  const fromId   = msg.from   || "";
  const authorUser = authorId.split("@")[0];
  const fromUser   = fromId.split("@")[0];
  const contact = await msg.getContact().catch(() => null);
  let number = null;
  try { number = contact && (await contact.getNumber?.()); } catch {}
  const widUser = contact?.id?.user || null;
  const phoneCandidate = number || widUser || null;
  const lidCandidate   = authorUser || fromUser || null;
  return {
    phoneId: phoneCandidate ? normPhone(phoneCandidate) : null,
    phoneIdLast10: phoneCandidate ? phoneCandidate.replace(/\D/g, "").slice(-10) : null,
    lid: lidCandidate || null
  };
}

/* ==================== Oyun Durumu & Blackjack ==================== */
const animations = ["ğŸ‚ ğŸ’«", "ğŸƒâœ¨", "ğŸ’¥ğŸ‚¡", "ğŸ´ğŸŒ€"];
const games = {};

function makeGameKey(msg, s) {
  const chat = (msg.from || "").split("@")[0];
  const author = (msg.author || "").split("@")[0];
  if (s.phoneId) return `p:${s.phoneId}`;
  if (author)  return `g:${chat}:${author}`;
  return `c:${chat}`;
}

const suits = ["â™ ï¸", "â™¥ï¸", "â™¦ï¸", "â™£ï¸"];
const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];

function drawCard() {
  const suit = suits[Math.floor(Math.random() * suits.length)];
  const value = values[Math.floor(Math.random() * values.length)];
  return { suit, value };
}
function getHandValue(hand) {
  let value = 0, aces = 0;
  for (const card of hand) {
    if (["J", "Q", "K"].includes(card.value)) value += 10;
    else if (card.value === "A") { value += 11; aces++; }
    else value += parseInt(card.value, 10);
  }
  while (value > 21 && aces > 0) { value -= 10; aces--; }
  return value;
}
function suitDot(suit) { return (suit === "â™¥ï¸" || suit === "â™¦ï¸") ? "ğŸ”´" : "âš«"; }
function handToDotString(hand) { return hand.map(c => `${c.value}${suitDot(c.suit)}`).join(" "); }
function valueText(val) { return (val > 21) ? "BUST! ğŸ’¥" : String(val); }

/* ==================== SLOT ==================== */
const symbols = ["ğŸ’", "ğŸ‹", "ğŸ‰", "ğŸ‡", "ğŸ¥", "ğŸ€", "â­"];
const paytable = { "ğŸ’": 2, "ğŸ‹": 3, "ğŸ‰": 4, "ğŸ‡": 5, "ğŸ¥": 6, "ğŸ€": 8, "â­": 12 };
let jackpot = 5000;

function spinSlot() {
  const grid = Array.from({ length: 3 }, () =>
    Array.from({ length: 3 }, () => symbols[Math.floor(Math.random() * symbols.length)])
  );
  return grid;
}
function checkSlotWin(grid, bet) {
  let totalWin = 0;
  const lines = [];
  for (let r = 0; r < 3; r++) {
    if (grid[r][0] === grid[r][1] && grid[r][1] === grid[r][2]) {
      const sym = grid[r][0];
      const win = bet * paytable[sym];
      totalWin += win;
      lines.push(`â­ SatÄ±r ${r + 1}: ${sym}${sym}${sym} â†’ +${win}`);
      if (sym === "â­") {
        totalWin += jackpot;
        lines.push(`ğŸ’¥ğŸ’° JACKPOT! +${jackpot} Ã‡ip!`);
        jackpot = 5000;
      }
    }
  }
  if (totalWin === 0) jackpot += Math.floor(bet * 0.2);
  return { totalWin, lines };
}

/* ==================== RULET ==================== */
const ROULET_HELP =
`ğŸ¡ *RULET Ã–ÄRETÄ°CÄ°SÄ°* ğŸ¡

KullanÄ±m: .rulet <miktar> <seÃ§im>

Ã–rnekler:
â€¢ .rulet 100 kÄ±rmÄ±zÄ±
â€¢ .rulet 200 tek
â€¢ .rulet 150 1-12
â€¢ .rulet 50 17
â€¢ .rulet 100 0`;

const REDS = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
function rouletteColor(n) {
  if (n === 0) return { name: "yeÅŸil", dot: "ğŸŸ¢" };
  if (REDS.has(n)) return { name: "kÄ±rmÄ±zÄ±", dot: "ğŸ”´" };
  return { name: "siyah", dot: "âš«" };
}
function rouletteSpin() {
  return Math.floor(Math.random() * 37);
}
function parseRoulettePick(rawTokens){
  const raw = normalizeTR(rawTokens.join(" "));
  if (!raw) return { ok:false, message: "KullanÄ±m: .rulet <miktar> <secim>. Ã–rn: .rulet 100 kirmizi" };
  const t = raw;

  const num = parseInt(t, 10);
  if (Number.isFinite(num) && num >= 0 && num <= 36) {
    return {
      ok: true, kind: "number", title: `SayÄ± ${num}`,
      test: (n)=> n === num, payout: 35
    };
  }
  if (["k","kirmizi","red"].includes(t)) {
    return { ok:true, kind:"color:red", title:"KÄ±rmÄ±zÄ±", test:(n)=> n!==0 && REDS.has(n), payout:1 };
  }
  if (["s","siyah","black"].includes(t)) {
    return { ok:true, kind:"color:black", title:"Siyah", test:(n)=> n!==0 && !REDS.has(n), payout:1 };
  }
  if (["tek","odd"].includes(t)) {
    return { ok:true, kind:"odd", title:"Tek", test:(n)=> n!==0 && n%2===1, payout:1 };
  }
  if (["cift","cif","even"].includes(t)) {
    return { ok:true, kind:"even", title:"Ã‡ift", test:(n)=> n!==0 && n%2===0, payout:1 };
  }
  if (["1-18","alt","low"].includes(t)) {
    return { ok:true, kind:"low", title:"1-18", test:(n)=> n>=1 && n<=18, payout:1 };
  }
  if (["19-36","ust","high","yuksek"].includes(t)) {
    return { ok:true, kind:"high", title:"19-36", test:(n)=> n>=19 && n<=36, payout:1 };
  }
  if (["1-12","d1","duzin1","duzine1"].includes(t)) {
    return { ok:true, kind:"dozen1", title:"1-12", test:(n)=> n>=1 && n<=12, payout:2 };
  }
  if (["13-24","d2","duzin2","duzine2"].includes(t)) {
    return { ok:true, kind:"dozen2", title:"13-24", test:(n)=> n>=13 && n<=24, payout:2 };
  }
  if (["25-36","d3","duzin3","duzine3"].includes(t)) {
    return { ok:true, kind:"dozen3", title:"25-36", test:(n)=> n>=25 && n<=36, payout:2 };
  }
  return { ok:false, message:
`âš ï¸ GeÃ§ersiz seÃ§im.
Ã–rnekler:
â€¢ .rulet 100 kÄ±rmÄ±zÄ±
â€¢ .rulet 200 tek
â€¢ .rulet 150 1-12
â€¢ .rulet 50 17
â€¢ .rulet 100 0` };
}

/* ==================== Hunt & Kutu ==================== */
const HUNT_COOLDOWN_MS = 3000;
const lastHuntTimes = {}; // keyId -> ms

const SLOT_COOLDOWN_MS = 3000;
const lastSlotTimes = {}; // keyId -> ms

const SPECIAL_DROP_RATES = {
  koala: 0.001,       // %0.1
  salyangoz: 0.002,   // %0.2
  kaplumbaga: 0.003   // %0.3
};

/* ==================== YardÄ±m Metni ==================== */
function buildHelpText(isAdmin) {
  const userPart =
`â™£ï¸ *Komutlar*
â€¢ .join â€” Oyuna katÄ±l
â€¢ .bakiye â€” Bakiyeni gÃ¶sterir
â€¢ .profil â€” Profilini gÃ¶sterir
â€¢ .stats â€” DetaylÄ± istatistik
â€¢ .gÃ¼nlÃ¼k â€” GÃ¼nlÃ¼k Ã¶dÃ¼l
â€¢ .slot <miktar> â€” Slot
â€¢ .rulet <miktar> <seÃ§im> â€” Rulet (Ã¶rn: .rulet 100 kÄ±rmÄ±zÄ±)
â€¢ .bj <miktar> â€” Blackjack baÅŸlat
â€¢ .hit | .stand | .db â€” Blackjack devam komutlarÄ±
â€¢ .hunt â€” Avlan, Ã§ip ve kutu kazan (3 sn bekleme)
â€¢ .kutu â€” 1 kutu aÃ§
â€¢ .kutu all â€” TÃ¼m kutularÄ± aÃ§
â€¢ .kristal â€” Kristal durumunu ve bozdurmayÄ± gÃ¶sterir

â„¹ï¸ Ã–rnek:
.slot 500
.rulet 200 tek
.bj 1000`;

  const adminPart =
`\n\nğŸ‘‘ *YÃ¶netici KomutlarÄ±*
â€¢ .allpman â€” Herkese +5000
â€¢ .alpman â€” Kendine +15000
â€¢ .max â€” Kendine 999999999 Ã§ip
â€¢ .send <miktar> @kiÅŸi â€” Ã‡ip gÃ¶nder
â€¢ .bakiye reset @kiÅŸi â€” Bakiyesini sÄ±fÄ±rla
â€¢ .listedenat @kiÅŸi â€” Skordan Ã§Ä±kar`;

  return isAdmin ? (userPart + adminPart) : userPart;
}

/* ==================== WhatsApp Client ==================== */
const client = new Client({
  authStrategy: new LocalAuth(),
  puppeteer: { headless: true, args: ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"] }
});

client.on("qr", qr => qrcode.generate(qr, { small: true }));
client.on("ready", () => console.log("âœ… Bot aktif!"));
client.on("auth_failure", m => console.error("âŒ Kimlik doÄŸrulama hatasÄ±:", m));
client.on("disconnected", r => console.warn("âš ï¸ BaÄŸlantÄ± koptu:", r));

/* ==================== Komutlar ==================== */
async function handleMessageSafe(msg) {
  if (!shouldProcess(msg)) return;

  try {
    const s = await resolveSender(msg);
    const isAdmin = isAdminCheck(s);
    const contact = await msg.getContact().catch(() => null);
    const name = contact?.pushname || contact?.name || msg._data?.notifyName || (s.phoneId || s.lid || "unknown");
    const keyId = s.phoneId || s.lid || (msg.author || msg.from);
    const player = getPlayer(keyId, name);

    if (player.stack <= 0) {
      player.stack = AUTO_TOPUP;
      await saveDB();
      try { await msg.reply(`ğŸ†“ Otomatik destek: +${AUTO_TOPUP} Ã§ip yÃ¼klendi. Bol ÅŸans!`); } catch {}
    }

    const keyGame = makeGameKey(msg, s);

    const body = (msg.body || "").trim();
    const args = body.split(/\s+/);
    const base = args[0]?.toLowerCase();

    // Basit ping
    if (body.toLowerCase() === "ping") {
      await msg.reply("pong");
      return;
    }

    if (!base.startsWith(".")) return; // komut deÄŸilse

    if (base === ".me") {
      return msg.reply(
        `name: ${player.name || "-"}\n` +
        `joined: ${player.joined}\n` +
        `keyId(DB): ${keyId}\nkeyGame(GAME): ${keyGame}\n` +
        `phoneId: ${s.phoneId || "-"} / last10: ${s.phoneIdLast10 || "-"}\n` +
        `lid: ${s.lid || "-"}\n` +
        `isAdmin: ${isAdmin}`
      );
    }

    if (base === ".yardÄ±m" || base === ".yardim" || base === ".help") {
      return msg.reply(buildHelpText(isAdmin));
    }

    if (base === ".join") {
      if (player.joined) {
        return msg.reply(`âœ… Zaten katÄ±ldÄ±n.\nğŸ¦ Bakiye: ${player.stack}`);
      }
      player.joined = true;
      await saveDB();
      return msg.reply(
`ğŸŸ *Oyuna katÄ±ldÄ±n!*
HoÅŸ geldin ${player.name || ""} ğŸ‰
ğŸ¦ BaÅŸlangÄ±Ã§ bakiyen: ${player.stack}
Bol ÅŸans!`
      );
    }

    // Oyuna katÄ±lmadan Ã§oÄŸu komutu engelle
    const needJoinCommands = [".bakiye",".profil",".stats",".gÃ¼nlÃ¼k",".gunluk",".slot",".rulet",".bj",".hit",".stand",".db",".hunt",".kutu",".kristal"];
    if (needJoinCommands.includes(base) && !player.joined) {
      return msg.reply("ğŸŸ Oyuna katÄ±lmak iÃ§in Ã¶nce `.join` yaz.");
    }

    if (base === ".bakiye") {
      return msg.reply(`ğŸ¦ Bakiye: ${player.stack}\nğŸ’ Kristal: ${player.crystals}`);
    }

    if (base === ".profil") {
      ensureStats(player);
      ensureInventory(player);
      const s2 = player.stats;
      const { level, totalXp } = calculatePlayerLevel(player);
      return msg.reply(
`ğŸ‘¤ *Profil Bilgileri*

Ad: ${player.name || "-"}
ğŸ¦ Bakiye: ${player.stack}
ğŸ’ Kristal: ${player.crystals}
â­ Seviye: ${level} (XP: ${totalXp})

ğŸ“Š *Genel Ä°statistikler*
â€¢ Slot oyunlarÄ±: ${s2.slotGames}
â€¢ Slot net kazanÃ§: ${s2.slotNetWin}
â€¢ Rulet galibiyetleri: ${s2.rouletteWins}/${s2.rouletteGames}
â€¢ BJ galibiyetleri: ${s2.bjWins}/${s2.bjGames}
â€¢ Hunt sayÄ±sÄ±: ${s2.huntCount}
â€¢ AÃ§Ä±lan kutu: ${s2.boxesOpened}
â€¢ GÃ¼nlÃ¼k aldÄ±ÄŸÄ±n gÃ¼n: ${s2.dailyDays}

ğŸ KutularÄ±n: ${player.inv.boxes}`
      );
    }

    if (base === ".stats") {
      ensureStats(player);
      const s2 = player.stats;
      const { level, totalXp } = calculatePlayerLevel(player);
      return msg.reply(
`ğŸ“Š *DetaylÄ± Ä°statistikler*

Oyuncu: ${player.name || "-"}
Seviye: ${level} (XP: ${totalXp})

ğŸ° Slot
â€¢ Oyun: ${s2.slotGames}
â€¢ Net kazanÃ§: ${s2.slotNetWin}

ğŸ¡ Rulet
â€¢ Oyun: ${s2.rouletteGames}
â€¢ Kazanma: ${s2.rouletteWins}
â€¢ Kaybetme: ${s2.rouletteLosses}

ğŸƒ Blackjack
â€¢ El: ${s2.bjGames}
â€¢ Kazanma: ${s2.bjWins}
â€¢ Kaybetme: ${s2.bjLosses}

ğŸ¹ Hunt
â€¢ Hunt sayÄ±sÄ±: ${s2.huntCount}
â€¢ Toplam kazanÃ§: ${s2.huntProfit}

ğŸ Kutu
â€¢ AÃ§Ä±lan kutu: ${s2.boxesOpened}
â€¢ Envanterdeki kutu: ${player.inv.boxes}

ğŸ“… GÃ¼nlÃ¼k aldÄ±ÄŸÄ±n gÃ¼n: ${s2.dailyDays}`
      );
    }

    if (base === ".gÃ¼nlÃ¼k" || base === ".gunluk") {
      const today = localDateKey();
      if (player.lastDaily === today) {
        return msg.reply("ğŸ“… BugÃ¼nkÃ¼ gÃ¼nlÃ¼k Ã¶dÃ¼lÃ¼nÃ¼ zaten aldÄ±n.");
      }
      player.lastDaily = today;
      ensureStats(player);
      player.stats.dailyDays += 1;
      player.stack += DAILY_REWARD;
      await saveDB();
      return msg.reply(
`ğŸ *GÃ¼nlÃ¼k Ã–dÃ¼l*

+${DAILY_REWARD} Ã§ip eklendi.
ğŸ¦ Yeni bakiye: ${player.stack}`
      );
    }

    if (base === ".slot") {
      const betStr = args[1];
      const bet = parseInt(betStr, 10);
      if (!Number.isFinite(bet) || bet < MIN_BET) {
        return msg.reply(`KullanÄ±m: .slot <miktar>\nMinimum bahis: ${MIN_BET}`);
      }
      if (bet > player.stack) {
        return msg.reply("ğŸš« Yetersiz bakiye.");
      }

      const now = Date.now();
      const last = lastSlotTimes[keyId] || 0;
      if (now - last < SLOT_COOLDOWN_MS) {
        const waitMs = SLOT_COOLDOWN_MS - (now - last);
        const waitSec = Math.ceil(waitMs / 1000);
        return msg.reply(`â³ Slot iÃ§in biraz bekle: ${waitSec} sn`);
      }
      lastSlotTimes[keyId] = now;

      player.stack -= bet;
      ensureStats(player);
      player.stats.slotGames += 1;

      const grid = spinSlot();
      const { totalWin, lines } = checkSlotWin(grid, bet);
      player.stack += totalWin;
      player.stats.slotNetWin += (totalWin - bet);

      await saveDB();

      const gridStr = grid.map(row => row.join(" ")).join("\n");
      const linesStr = lines.length ? lines.join("\n") : "Maalesef kazanÃ§ yok.";
      return msg.reply(
`ğŸ° *Slot*

${gridStr}

${linesStr}

ğŸ¦ Bakiye: ${player.stack}`
      );
    }

    if (base === ".rulet") {
      if (args.length === 1) {
        return msg.reply(ROULET_HELP);
      }
      const bet = parseInt(args[1], 10);
      if (!Number.isFinite(bet) || bet < MIN_BET) {
        return msg.reply(`KullanÄ±m: .rulet <miktar> <seÃ§im>\nMinimum bahis: ${MIN_BET}`);
      }
      if (bet > player.stack) {
        return msg.reply("ğŸš« Yetersiz bakiye.");
      }
      const pick = parseRoulettePick(args.slice(2));
      if (!pick.ok) return msg.reply(pick.message);

      player.stack -= bet;
      ensureStats(player);
      player.stats.rouletteGames += 1;

      const result = rouletteSpin();
      const color = rouletteColor(result);
      let win = 0;
      let text = "";

      if (pick.test(result)) {
        win = bet * pick.payout;
        player.stack += bet + win;
        player.stats.rouletteWins += 1;
        text = `âœ… KazandÄ±n! Bahis: ${bet}, KazanÃ§: +${win}`;
      } else {
        player.stats.rouletteLosses += 1;
        text = `âŒ Kaybettin. Bahis: ${bet}`;
      }

      await saveDB();

      return msg.reply(
`ğŸ¡ *Rulet*

SeÃ§imin: ${pick.title}
Gelen sayÄ±: ${result} ${color.dot} (${color.name})

${text}

ğŸ¦ Bakiye: ${player.stack}`
      );
    }

    if (base === ".bj") {
      const betStr = args[1];
      const bet = parseInt(betStr, 10);
      if (!Number.isFinite(bet) || bet < MIN_BET) {
        return msg.reply(`KullanÄ±m: .bj <miktar>\nMinimum bahis: ${MIN_BET}`);
      }
      if (bet > player.stack) {
        return msg.reply("ğŸš« Yetersiz bakiye.");
      }

      player.stack -= bet;
      ensureStats(player);
      player.stats.bjGames += 1;

      const playerHand = [drawCard(), drawCard()];
      const dealerHand = [drawCard(), drawCard()];

      games[keyGame] = {
        type: "bj",
        bet,
        playerId: keyId,
        playerHand,
        dealerHand,
        finished: false
      };

      const pVal = getHandValue(playerHand);
      const dVisible = dealerHand[0];

      await saveDB();

      return msg.reply(
`ğŸƒ *Blackjack BaÅŸladÄ±*

Sen: ${handToDotString(playerHand)} (${valueText(pVal)})
DaÄŸÄ±tÄ±cÄ±: ${dVisible.value}${suitDot(dVisible.suit)} + ğŸ‚ 

Komutlar:
â€¢ .hit â€” Kart Ã§ek
â€¢ .stand â€” Kal
â€¢ .db â€” Double (bahsi 2x yapÄ±p 1 kart Ã§ek)`
      );
    }

    if (base === ".hit" || base === ".stand" || base === ".db") {
      const g = games[keyGame];
      if (!g || g.type !== "bj" || g.finished) {
        return msg.reply("ğŸ´ Aktif bir blackjack oyunun yok. `.bj <miktar>` ile baÅŸlat.");
      }

      if (g.playerId !== keyId) {
        return msg.reply("Bu blackjack eli sana ait deÄŸil.");
      }

      if (base === ".hit") {
        g.playerHand.push(drawCard());
        const pVal = getHandValue(g.playerHand);
        const dVis = g.dealerHand[0];
        if (pVal > 21) {
          g.finished = true;
          await saveDB();
          ensureStats(player);
          player.stats.bjLosses += 1;
          return msg.reply(
`ğŸƒ *Blackjack*

Sen: ${handToDotString(g.playerHand)} (${valueText(pVal)})
DaÄŸÄ±tÄ±cÄ±: ${handToDotString(g.dealerHand)} (${getHandValue(g.dealerHand)})

ğŸ’¥ Bust oldun, kaybettin.
Bahis: ${g.bet}

ğŸ¦ Bakiye: ${player.stack}`
          );
        }
        await saveDB();
        return msg.reply(
`ğŸƒ *Hit*

Sen: ${handToDotString(g.playerHand)} (${valueText(pVal)})
DaÄŸÄ±tÄ±cÄ±: ${dVis.value}${suitDot(dVis.suit)} + ğŸ‚ 

Komutlar:
â€¢ .hit â€” Kart Ã§ek
â€¢ .stand â€” Kal`
        );
      }

      if (base === ".db") {
        if (player.stack < g.bet) {
          return msg.reply("ğŸ’¸ Double iÃ§in yeterli bakiyen yok.");
        }
        player.stack -= g.bet;
        g.bet *= 2;
        g.playerHand.push(drawCard());
        let pVal = getHandValue(g.playerHand);

        // Dealer oynar
        while (getHandValue(g.dealerHand) < 17) {
          g.dealerHand.push(drawCard());
        }
        const dVal = getHandValue(g.dealerHand);
        g.finished = true;

        let resultText = "";
        if (pVal > 21) {
          ensureStats(player); player.stats.bjLosses += 1;
          resultText = "ğŸ’¥ Bust oldun, kaybettin.";
        } else if (dVal > 21 || pVal > dVal) {
          const win = g.bet * 2;
          player.stack += win;
          ensureStats(player); player.stats.bjWins += 1;
          resultText = `âœ… KazandÄ±n! +${win - g.bet} Ã§ip (toplam ${win})`;
        } else if (pVal === dVal) {
          player.stack += g.bet;
          resultText = "ğŸ¤ Berabere, bahis iade.";
        } else {
          ensureStats(player); player.stats.bjLosses += 1;
          resultText = "âŒ Kaybettin.";
        }

        await saveDB();
        return msg.reply(
`ğŸƒ *Blackjack â€” Double*

Sen: ${handToDotString(g.playerHand)} (${valueText(pVal)})
DaÄŸÄ±tÄ±cÄ±: ${handToDotString(g.dealerHand)} (${valueText(dVal)})

Bahis (2x): ${g.bet}
${resultText}

ğŸ¦ Bakiye: ${player.stack}`
        );
      }

      if (base === ".stand") {
        // Dealer oynar
        while (getHandValue(g.dealerHand) < 17) {
          g.dealerHand.push(drawCard());
        }
        const pVal = getHandValue(g.playerHand);
        const dVal = getHandValue(g.dealerHand);
        g.finished = true;

        let resultText = "";
        if (dVal > 21 || pVal > dVal) {
          const win = g.bet * 2;
          player.stack += win;
          ensureStats(player); player.stats.bjWins += 1;
          resultText = `âœ… KazandÄ±n! +${win - g.bet} Ã§ip (toplam ${win})`;
        } else if (pVal === dVal) {
          player.stack += g.bet;
          resultText = "ğŸ¤ Berabere, bahis iade.";
        } else {
          ensureStats(player); player.stats.bjLosses += 1;
          resultText = "âŒ Kaybettin.";
        }

        await saveDB();
        return msg.reply(
`ğŸƒ *Blackjack â€” Stand*

Sen: ${handToDotString(g.playerHand)} (${valueText(pVal)})
DaÄŸÄ±tÄ±cÄ±: ${handToDotString(g.dealerHand)} (${valueText(dVal)})

Bahis: ${g.bet}
${resultText}

ğŸ¦ Bakiye: ${player.stack}`
        );
      }
    }

    if (base === ".hunt") {
      const now = Date.now();
      const last = lastHuntTimes[keyId] || 0;
      if (now - last < HUNT_COOLDOWN_MS) {
        const waitMs = HUNT_COOLDOWN_MS - (now - last);
        const waitSec = Math.ceil(waitMs / 1000);
        return msg.reply(`â³ Hunt iÃ§in biraz bekle: ${waitSec} sn`);
      }
      lastHuntTimes[keyId] = now;

      const gain = randInt(200, 800);
      const boxChance = Math.random();
      let gotBox = false;
      if (boxChance < 0.25) { // %25 kutu
        player.inv.boxes += 1;
        gotBox = true;
      }

      ensureStats(player);
      player.stack += gain;
      player.stats.huntCount += 1;
      player.stats.huntProfit += gain;

      await saveDB();

      return msg.reply(
`ğŸ¹ *Hunt sonucu*

KazanÃ§: +${gain} Ã§ip
${gotBox ? "ğŸ 1 kutu kazandÄ±n!" : "Bu sefer kutu Ã§Ä±kmadÄ±."}

ğŸ¦ Bakiye: ${player.stack}
ğŸ KutularÄ±n: ${player.inv.boxes}`
      );
    }

    if (base === ".kutu") {
      if (player.inv.boxes <= 0) {
        return msg.reply("ğŸ HiÃ§ kutun yok. Hunt yaparak kutu kazanabilirsin: `.hunt`");
      }

      let openAll = false;
      if (args[1] && args[1].toLowerCase() === "all") openAll = true;

      let count = openAll ? player.inv.boxes : 1;
      let totalGain = 0;
      let crystalGain = 0;
      let specialPet = [];

      for (let i = 0; i < count; i++) {
        const gain = randInt(500, 2000);
        totalGain += gain;
        const r = Math.random();
        if (r < 0.05) { // %5 kristal
          crystalGain += 1;
        }
        // Ã¶zel pet ÅŸansÄ±nÄ± sadece metin olarak yazacaÄŸÄ±z
        const sp = Math.random();
        if (sp < SPECIAL_DROP_RATES.koala) specialPet.push("ğŸ¨ Koala");
        else if (sp < SPECIAL_DROP_RATES.koala + SPECIAL_DROP_RATES.salyangoz) specialPet.push("ğŸŒ Salyangoz");
        else if (sp < SPECIAL_DROP_RATES.koala + SPECIAL_DROP_RATES.salyangoz + SPECIAL_DROP_RATES.kaplumbaga) specialPet.push("ğŸ¢ KaplumbaÄŸa");
      }

      player.inv.boxes -= count;
      ensureStats(player);
      player.stats.boxesOpened += count;
      player.stack += totalGain;
      player.crystals += crystalGain;

      await saveDB();

      let petText = specialPet.length ? `\nâ­ Ã–zel: ${specialPet.join(", ")}` : "";
      return msg.reply(
`ğŸ *Kutu AÃ§ma*

AÃ§Ä±lan kutu: ${count}
Toplam Ã§ip kazancÄ±: +${totalGain}
Kristal kazancÄ±: +${crystalGain}${petText}

ğŸ¦ Bakiye: ${player.stack}
ğŸ’ Kristal: ${player.crystals}
ğŸ Kalan kutu: ${player.inv.boxes}`
      );
    }

    if (base === ".kristal") {
      const sub = (args[1] || "").toLowerCase();
      if (!sub) {
        return msg.reply(
`ğŸ’ *Kristal Durumu*

Oyuncu: ${player.name || "-"}
ğŸ’ Kristal: ${player.crystals}
1 kristal = ${CRYSTAL_TO_CHIP} Ã§ip

Kristali Ã§ipe Ã§evirmek iÃ§in:
.kristal bozdur <miktar>
Ã–rn: .kristal bozdur 3
.kristal bozdur max`
        );
      }
      if (sub === "bozdur" || sub === "boz") {
        const rawAmount = (args[2] || "").toLowerCase();
        if (!rawAmount) {
          return msg.reply(
`KullanÄ±m:
.kristal bozdur <miktar>
Ã–rn:
.kristal bozdur 2
.kristal bozdur max`
          );
        }
        let amount;
        if (rawAmount === "max" || rawAmount === "hepsi" || rawAmount === "all") {
          amount = player.crystals;
        } else {
          amount = parseInt(rawAmount, 10);
        }
        if (!Number.isFinite(amount) || amount <= 0) {
          return msg.reply("âš ï¸ GeÃ§erli bir kristal miktarÄ± gir.");
        }
        if (amount > player.crystals) {
          return msg.reply(`ğŸš« Yetersiz kristal. Senin: ${player.crystals}, Ä°stenen: ${amount}`);
        }
        const chipGain = amount * CRYSTAL_TO_CHIP;
        player.crystals -= amount;
        player.stack += chipGain;
        await saveDB();
        return msg.reply(
`âœ… *Kristal Bozduruldu*

Bozdurulan: ${amount} kristal
KazanÃ§: +${chipGain} Ã§ip

ğŸ’ Kalan kristal: ${player.crystals}
ğŸ¦ Bakiye: ${player.stack}`
        );
      }

      return msg.reply(
`ğŸ’ *Kristal KomutlarÄ±*
.kristal â€” Durumu gÃ¶sterir
.kristal bozdur <miktar>
.kristal bozdur max`
      );
    }

    /* ===== Admin para komutlarÄ± ===== */
    if (isAdmin) {
      if (base === ".allpman") {
        for (const p of Object.values(db.data.players)) {
          p.stack = (p.stack || 0) + 5000;
        }
        await saveDB();
        return msg.reply("ğŸ‘‘ Herkese +5000 Ã§ip verildi.");
      }
      if (base === ".alpman") {
        player.stack += 15000;
        await saveDB();
        return msg.reply(`ğŸ‘‘ Kendine +15000 Ã§ip verdin.\nYeni bakiye: ${player.stack}`);
      }
      if (base === ".max") {
        player.stack = 999999999;
        await saveDB();
        return msg.reply(`ğŸ’¸ Bakiye MAX yapÄ±ldÄ±: ${player.stack}`);
      }

      if (base === ".send") {
        const amountStr = args[1];
        if (!amountStr) return msg.reply("KullanÄ±m: .send <miktar> @kiÅŸi");
        const amount = parseInt(amountStr, 10);
        if (!Number.isFinite(amount) || amount <= 0) return msg.reply("GeÃ§erli bir miktar gir.");
        if (amount > player.stack) return msg.reply("ğŸš« Yetersiz bakiye.");

        const mentions = await msg.getMentions();
        if (!mentions || !mentions.length) {
          return msg.reply("Bir kiÅŸiyi @ ile etiketlemen lazÄ±m.");
        }
        const targetContact = mentions[0];
        let tNumber = null;
        try { tNumber = await targetContact.getNumber(); } catch {}
        const targetId = tNumber ? normPhone(tNumber) : targetContact.id.user;
        if (!targetId) return msg.reply("Hedef kiÅŸi bulunamadÄ±.");

        const targetPlayer = getPlayer(targetId, targetContact.pushname || targetContact.name || targetId);
        player.stack -= amount;
        targetPlayer.stack += amount;
        await saveDB();

        return msg.reply(
`âœ… Transfer tamamlandÄ±.
GÃ¶nderen: ${player.name || "-"}
AlÄ±cÄ±: ${targetPlayer.name || "-"}
Tutar: ${amount}

Senin bakiye: ${player.stack}`
        );
      }

      if (base === ".bakiye" && args[1] === "reset") {
        const mentions = await msg.getMentions();
        if (!mentions || !mentions.length) return msg.reply("KullanÄ±m: .bakiye reset @kiÅŸi");
        const targetContact = mentions[0];
        let tNumber = null;
        try { tNumber = await targetContact.getNumber(); } catch {}
        const targetId = tNumber ? normPhone(tNumber) : targetContact.id.user;
        const targetPlayer = getPlayer(targetId, targetContact.pushname || targetContact.name || targetId);
        targetPlayer.stack = STARTING_STACK;
        await saveDB();
        return msg.reply(`ğŸ” ${targetPlayer.name || "-"} bakiyesi sÄ±fÄ±rlandÄ± / baÅŸlangÄ±ca Ã§ekildi: ${STARTING_STACK}`);
      }
    }

    if (base === ".score") {
      const allPlayers = Object.entries(db.data.players || {});
      const sorted = allPlayers
        .map(([id, p]) => [id, p])
        .sort((a, b) => (b[1].stack || 0) - (a[1].stack || 0))
        .slice(0, 10);
      if (!sorted.length) return msg.reply("HenÃ¼z hiÃ§ oyuncu yok.");
      const lines = sorted.map(([id, p], i) =>
        `${i + 1}. ${p.name || id} â€” ${p.stack} Ã§ip`
      ).join("\n");
      return msg.reply(`ğŸ† *Skor Tablosu (Ä°lk 10)*\n\n${lines}`);
    }

  } catch (err) {
    console.error("Mesaj iÅŸleme hatasÄ±:", err);
    try { await msg.reply("âš ï¸ Ä°Ã§ hata oluÅŸtu, lÃ¼tfen tekrar dene."); } catch {}
  }
}

client.on("message", handleMessageSafe);
client.initialize();
