import wwjs from "whatsapp-web.js";
const { Client, LocalAuth } = wwjs;
import qrcode from "qrcode-terminal";
import fs from "fs";
import path from "path";
import dotenv from "dotenv";
import { Low } from "lowdb";
import { JSONFile } from "lowdb/node";

dotenv.config();

/* ==================== Telefon YardÄ±mcÄ±larÄ± ==================== */
function normPhone(raw) {
  const d = (raw || "").replace(/\D/g, "");
  if (d.startsWith("90") && d.length === 12) return d;       // 90xxxxxxxxxx
  if (d.startsWith("0") && d.length === 11) return "9" + d;  // 0xxxxxxxxxx -> 90xxxxxxxxxx
  if (d.length === 10) return "90" + d;                      // xxxxxxxxxx  -> 90xxxxxxxxxx
  return d;
}
function last10(s) {
  const d = (s || "").replace(/\D/g, "");
  return d.slice(-10);
}

/* ==================== DB Kurulumu ==================== */
const DATA_DIR = process.env.DATA_DIR || "./data";
if (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, { recursive: true });

const dbFile = path.join(DATA_DIR, "players.json");
const adapter = new JSONFile(dbFile);
const db = new Low(adapter, { players: {} });

await (async () => {
  try { await db.read(); }
  catch {
    db.data = { players: {} };
    await db.write();
  }
})();
if (!db.data) db.data = { players: {} };

const STARTING_STACK = parseInt(process.env.STARTING_STACK || "100", 10);
const MIN_BET = parseInt(process.env.MIN_BET || "5", 10);
const DAILY_REWARD = parseInt(process.env.DAILY_REWARD || "2500", 10); // GÃœNLÃœK Ã–DÃœL 2500
const AUTO_TOPUP = parseInt(process.env.AUTO_TOPUP || "3000", 10);

/* ==== Kristal Sistemi ve Profil TemalarÄ± ==== */
const CRYSTAL_TO_CHIP_RATE = parseInt(process.env.CRYSTAL_TO_CHIP_RATE || "500", 10); 
// 1 kristal = 500 Ã§ip

const CRYSTAL_DROP_BASE = parseFloat(process.env.CRYSTAL_DROP_BASE || "0.05");   // %5
const CRYSTAL_DROP_EVENT = parseFloat(process.env.CRYSTAL_DROP_EVENT || "0.10"); // %10
const CRYSTAL_MIN = 1;
const CRYSTAL_MAX = 3;

const PROFILE_SKINS = {
  default: {
    key: "default",
    name: "Standart Profil",
    rarity: "SÄ±radan",
    crystalPrice: 0,
    adminOnly: false
  },
  neon: {
    key: "neon",
    name: "Neon Oyuncu",
    rarity: "Nadir",
    crystalPrice: 80,
    adminOnly: false
  },
  mythic: {
    key: "mythic",
    name: "Efsane GÃ¶steriÅŸ",
    rarity: "Efsanevi",
    crystalPrice: 150,
    adminOnly: false
  },
  admin_throne: {
    key: "admin_throne",
    name: "ğŸ‘‘ YÃ¶netici TahtÄ±",
    rarity: "Admin",
    crystalPrice: 0,
    adminOnly: true
  }
};

/* ==== Admin yapÄ±landÄ±rma (.env + kalÄ±cÄ± dosya) ==== */
const ADMIN_PIN = (process.env.ADMIN_PIN || "1234").trim();
const ADMIN_PHONES = (process.env.ADMIN_PHONES || process.env.ADMIN_PHONE || "")
  .split(",")
  .map(s => s.trim())
  .filter(Boolean)
  .map(normPhone);

// KalÄ±cÄ± admin dosyasÄ±
const adminsFile = path.join(DATA_DIR, "admins.json");
if (!fs.existsSync(adminsFile)) {
  fs.writeFileSync(adminsFile, JSON.stringify({ phones: [], lids: [] }, null, 2), "utf8");
}
function readAdmins() {
  try { return JSON.parse(fs.readFileSync(adminsFile, "utf8")); }
  catch { return { phones: [], lids: [] }; }
}
function writeAdmins(obj) {
  fs.writeFileSync(adminsFile, JSON.stringify(obj, null, 2), "utf8");
}

/* ==================== Utils ==================== */
function localDateKey(ms = Date.now(), tz = "Europe/Istanbul") {
  return new Date(ms).toLocaleDateString("tr-TR", { timeZone: tz });
}
async function saveDB() { await db.write(); }

function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function normalizeTR(s) {
  return (s || "")
    .toLowerCase()
    .replace(/Ä±/g, "i")
    .replace(/ÅŸ/g, "s")
    .replace(/Ã§/g, "c")
    .replace(/Ã¶/g, "o")
    .replace(/Ã¼/g, "u")
    .replace(/ÄŸ/g, "g")
    .trim();
}

/* ===== Global Event Buff (admin etkinliÄŸi) ===== */
let eventBuff = {
  active: false,
  until: 0
};

function isEventBuffActive() {
  if (!eventBuff.active) return false;
  if (Date.now() >= eventBuff.until) {
    eventBuff.active = false;
    eventBuff.until = 0;
    return false;
  }
  return true;
}

function eventBuffRemainingText() {
  if (!isEventBuffActive()) return "kapalÄ±";
  const ms = eventBuff.until - Date.now();
  const sec = Math.max(1, Math.round(ms / 1000));
  const min = Math.floor(sec / 60);
  const s = sec % 60;
  return min > 0 ? `${min} dk ${s} sn` : `${s} sn`;
}

/* ===== Ä°STATÄ°STÄ°K, ENVANTER, GÃ–REV, PET VE UNVAN SÄ°STEMÄ° ===== */

/* --- Oyuncu istatistikleri --- */
function ensureStats(player) {
  if (!player.stats || typeof player.stats !== "object") {
    player.stats = {
      slotGames: 0,
      slotNetWin: 0,
      rouletteGames: 0,
      rouletteWins: 0,
      rouletteLosses: 0,
      bjGames: 0,
      bjWins: 0,
      bjLosses: 0,
      dailyDays: 0,
      huntCount: 0,
      huntProfit: 0,
      boxesOpened: 0
    };
  } else {
    const s = player.stats;
    if (typeof s.slotGames !== "number") s.slotGames = 0;
    if (typeof s.slotNetWin !== "number") s.slotNetWin = 0;
    if (typeof s.rouletteGames !== "number") s.rouletteGames = 0;
    if (typeof s.rouletteWins !== "number") s.rouletteWins = 0;
    if (typeof s.rouletteLosses !== "number") s.rouletteLosses = 0;
    if (typeof s.bjGames !== "number") s.bjGames = 0;
    if (typeof s.bjWins !== "number") s.bjWins = 0;
    if (typeof s.bjLosses !== "number") s.bjLosses = 0;
    if (typeof s.dailyDays !== "number") s.dailyDays = 0;
    if (typeof s.huntCount !== "number") s.huntCount = 0;
    if (typeof s.huntProfit !== "number") s.huntProfit = 0;
    if (typeof s.boxesOpened !== "number") s.boxesOpened = 0;
  }
}

/* --- Seviye sistemi: istatistiklerden hesaplanÄ±r --- */
function calculatePlayerLevel(player) {
  ensureStats(player);
  const s = player.stats || {};

  const totalXp =
    (s.slotGames || 0)     * 2 +
    (s.rouletteGames || 0) * 3 +
    (s.bjGames || 0)       * 3 +
    (s.huntCount || 0)     * 5 +
    (s.boxesOpened || 0)   * 4 +
    (s.dailyDays || 0)     * 10;

  const level = Math.max(1, Math.floor(totalXp / 100) + 1);

  return { level, totalXp };
}

/* --- Envanter (kutu) --- */
function ensureInventory(player) {
  if (!player.inv || typeof player.inv !== "object") {
    player.inv = { boxes: 0 };
  } else {
    if (typeof player.inv.boxes !== "number") player.inv.boxes = 0;
  }
}

/* --- Pet sistemi: Ã§oklu pet + aktif pet + pasif katkÄ± --- */
const PET_SHOP = {
  cekirge: {
    key: "cekirge",
    emoji: "ğŸ¦—",
    label: "Ã‡ekirge",
    price: 6000,
    crystalPrice: 15,
    atk: 5,
    luck: 15,
    buyable: true,
    desc: "HÄ±zlÄ± ve ÅŸanslÄ±, ucuz giriÅŸ seviyesi pet."
  },
  karinca: {
    key: "karinca",
    emoji: "ğŸœ",
    label: "KarÄ±nca",
    price: 8000,
    crystalPrice: 18,
    atk: 8,
    luck: 8,
    buyable: true,
    desc: "KÃ¼Ã§Ã¼k ama Ã§alÄ±ÅŸkan; uzun vadede saÄŸlam katkÄ±."
  },
  panda: {
    key: "panda",
    emoji: "ğŸ¼",
    label: "Panda",
    price: 16000,
    crystalPrice: 35,
    atk: 30,
    luck: 30,
    buyable: true,
    desc: "Dengeli ve gÃ¼Ã§lÃ¼ bir pet."
  },
  keci: {
    key: "keci",
    emoji: "ğŸ",
    label: "KeÃ§i",
    price: 24000,
    crystalPrice: 45,
    atk: 40,
    luck: 20,
    buyable: true,
    desc: "Ä°natÃ§Ä±; Ã¶zellikle hunt kazancÄ±nÄ± bufflar."
  },
  at: {
    key: "at",
    emoji: "ğŸ´",
    label: "At",
    price: 30000,
    crystalPrice: 55,
    atk: 35,
    luck: 15,
    buyable: true,
    desc: "Dengeli, hÄ±z odaklÄ± pet."
  },
  zebra: {
    key: "zebra",
    emoji: "ğŸ¦“",
    label: "Zebra",
    price: 36000,
    crystalPrice: 60,
    atk: 30,
    luck: 25,
    buyable: true,
    desc: "Hem ÅŸans hem saldÄ±rÄ± aÃ§Ä±sÄ±ndan ortalama Ã¼stÃ¼."
  },
  kedi: {
    key: "kedi",
    emoji: "ğŸ±",
    label: "Kedi",
    price: 40000,
    crystalPrice: 70,
    atk: 10,
    luck: 20,
    buyable: true,
    desc: "Dengeli, ÅŸanslÄ± kÃ¼Ã§Ã¼k bir avcÄ±."
  },
  tavsan: {
    key: "tavsan",
    emoji: "ğŸ°",
    label: "TavÅŸan",
    price: 44000,
    crystalPrice: 80,
    atk: 10,
    luck: 30,
    buyable: true,
    desc: "Ã‡ok ÅŸanslÄ±, Ã¶zellikle kutu ve drop iÅŸinde iyi."
  },
  kopek: {
    key: "kopek",
    emoji: "ğŸ¶",
    label: "KÃ¶pek",
    price: 50000,
    crystalPrice: 90,
    atk: 20,
    luck: 10,
    buyable: true,
    desc: "Daha agresif; hunt kazancÄ± biraz daha yÃ¼ksek."
  },
  kartal: {
    key: "kartal",
    emoji: "ğŸ¦…",
    label: "Kartal",
    price: 60000,
    crystalPrice: 110,
    atk: 45,
    luck: 35,
    buyable: true,
    desc: "YÃ¼ksek gÃ¶rÃ¼ÅŸ, yÃ¼ksek ÅŸans."
  },
  suaygiri: {
    key: "suaygiri",
    emoji: "ğŸ¦›",
    label: "Su AygÄ±rÄ±",
    price: 64000,
    crystalPrice: 115,
    atk: 60,
    luck: 25,
    buyable: true,
    desc: "AÄŸÄ±r ve tank; hunt kazancÄ±nÄ± iyi bufflar."
  },
  fil: {
    key: "fil",
    emoji: "ğŸ˜",
    label: "Fil",
    price: 80000,
    crystalPrice: 130,
    atk: 70,
    luck: 30,
    buyable: true,
    desc: "GÃ¼Ã§lÃ¼, sabit ve gÃ¼venilir pet."
  },
  tilki: {
    key: "tilki",
    emoji: "ğŸ¦Š",
    label: "Tilki",
    price: 90000,
    crystalPrice: 140,
    atk: 30,
    luck: 20,
    buyable: true,
    desc: "Kurnaz avcÄ±; hem hunt hem kutuda gÃ¼Ã§lÃ¼."
  },
  gergedan: {
    key: "gergedan",
    emoji: "ğŸ¦",
    label: "Gergedan",
    price: 120000,
    crystalPrice: 160,
    atk: 90,
    luck: 20,
    buyable: true,
    desc: "AÄŸÄ±r darbe vuran, saldÄ±rÄ± odaklÄ± pet."
  },
  cita: {
    key: "cita",
    emoji: "ğŸ†",
    label: "Ã‡ita",
    price: 150000,
    crystalPrice: 190,
    atk: 100,
    luck: 35,
    buyable: true,
    desc: "Ã‡ok hÄ±zlÄ± ve tehlikeli avcÄ±."
  },
  aslan: {
    key: "aslan",
    emoji: "ğŸ¦",
    label: "Aslan",
    price: 200000,
    crystalPrice: 240,
    atk: 150,
    luck: 40,
    buyable: true,
    desc: "OrmanÄ±n kralÄ±; efsane gÃ¼Ã§te pet."
  },
  ejderha: {
    key: "ejderha",
    emoji: "ğŸ‰",
    label: "Ejderha",
    price: 400000,
    crystalPrice: 400,
    atk: 100,
    luck: 100,
    buyable: true,
    desc: "Efsane pet. Hem yÃ¼ksek kazanÃ§ hem ekstra ÅŸans."
  },

  /* â€” Kutudan Ã§Ä±kan Ã¶zel petler (artÄ±k kristalle de alÄ±nabilir) â€” */
  kaplumbaga: {
    key: "kaplumbaga",
    emoji: "ğŸ¢",
    label: "KaplumbaÄŸa (Koleksiyon)",
    price: 0,
    crystalPrice: 130,
    buyable: false,
    atk: 50,
    luck: 50,
    desc: "Sadece kutudan Ã§Ä±kan ama kristalle de alÄ±nabilen koleksiyon peti."
  },
  salyangoz: {
    key: "salyangoz",
    emoji: "ğŸŒ",
    label: "Salyangoz (Ã–zel)",
    price: 0,
    crystalPrice: 140,
    buyable: false,
    atk: 20,
    luck: 10,
    desc: "Ã–zel pet. Hunt drop ÅŸansÄ±nÄ± arttÄ±rÄ±r. Kutudan Ã§Ä±kabilir, kristalle de alÄ±nabilir."
  },
  koala: {
    key: "koala",
    emoji: "ğŸ¨",
    label: "Koala (Efsane)",
    price: 0,
    crystalPrice: 180,
    buyable: false,
    atk: 30,
    luck: 30,
    desc: "Efsane pet. Kutudan Ã§Ä±kabilir, kristalle de alÄ±nabilir. Bot aÃ§Ä±kken her 30 dakikada bir +3000 Ã§ip pasif gelir kazandÄ±rÄ±r."
  }
};

/* --- Adminâ€™e Ã¶zel pet --- */
const ADMIN_PET = {
  key: "adminkurt",
  emoji: "ğŸº",
  label: "Alfa Kurt",
  atk: 999,
  luck: 999
};

function petTypeFromInput(raw) {
  const t = normalizeTR(raw || "");
  if (["cekirge","cekirga","cikrik"].includes(t)) return "cekirge";
  if (["karinca","karÄ±nca","ant"].includes(t)) return "karinca";
  if (["panda"].includes(t)) return "panda";
  if (["keci","keÃ§i","goat"].includes(t)) return "keci";
  if (["at","horse"].includes(t)) return "at";
  if (["zebra"].includes(t)) return "zebra";
  if (["kedi","cat","pisi"].includes(t)) return "kedi";
  if (["tavsan","tavÅŸan","rabbit","bunny"].includes(t)) return "tavsan";
  if (["kopek","kÃ¶pek","kope","dog"].includes(t)) return "kopek";
  if (["kartal","eagle"].includes(t)) return "kartal";
  if (["suaygiri","su","aygiri","hippo"].includes(t)) return "suaygiri";
  if (["fil","elephant"].includes(t)) return "fil";
  if (["tilki","fox"].includes(t)) return "tilki";
  if (["gergedan","rhino"].includes(t)) return "gergedan";
  if (["cita","Ã§ita","cheetah"].includes(t)) return "cita";
  if (["aslan","lion"].includes(t)) return "aslan";
  if (["ejder","ejderha","dragon"].includes(t)) return "ejderha";
  if (["kaplumbaga","kaplumbaÄŸa","turtle"].includes(t)) return "kaplumbaga";
  if (["salyangoz","snail"].includes(t)) return "salyangoz";
  if (["koala"].includes(t)) return "koala";
  return null;
}

function ensurePet(player) {
  if (!player.pets) {
    if (player.pet) {
      player.pets = [player.pet];
    } else {
      player.pets = [];
    }
  }
  if (!Array.isArray(player.pets)) player.pets = [];
  if (typeof player.activePetIndex !== "number") {
    player.activePetIndex = player.pets.length ? 0 : -1;
  }
  if (player.activePetIndex >= player.pets.length) {
    player.activePetIndex = player.pets.length ? 0 : -1;
  }
  player.pet = player.pets[player.activePetIndex] || null;
}

function getPetDisplayName(p) {
  if (!p) return "-";
  const def = p.type && PET_SHOP[p.type];
  const base = def?.label || p.type || "Pet";
  if (p.name && p.name !== base) return `${p.name} (${base})`;
  return base;
}

function getPetPower(player) {
  ensurePet(player);
  const pets = player.pets || [];
  if (!pets.length) {
    return { atk: 0, luck: 0, active: null, others: [] };
  }
  let idx = player.activePetIndex;
  if (!Number.isFinite(idx) || idx < 0 || idx >= pets.length) {
    idx = 0;
    player.activePetIndex = 0;
  }
  const active = pets[idx];
  const others = pets.filter((_, i) => i !== idx);
  let atk = active.atk || 0;
  let luck = active.luck || 0;
  for (const p of others) {
    atk += (p.atk || 0) * 0.15;
    luck += (p.luck || 0) * 0.15;
  }
  player.pet = active;
  return { atk, luck, active, others };
}

function hasPetType(player, type) {
  ensurePet(player);
  return (player.pets || []).some(p => p.type === type);
}

function grantPet(player, type) {
  ensurePet(player);
  const def = PET_SHOP[type];
  if (!def && type !== ADMIN_PET.key) return null;

  if (type !== ADMIN_PET.key) {
    if (hasPetType(player, type)) return null;
    const pet = {
      type: def.key,
      name: def.label,
      level: 1,
      xp: 0,
      atk: def.atk,
      luck: def.luck
    };
    player.pets.push(pet);
    if (player.activePetIndex === -1) player.activePetIndex = player.pets.length - 1;
    player.pet = player.pets[player.activePetIndex];
    return pet;
  } else {
    const pet = {
      type: ADMIN_PET.key,
      name: ADMIN_PET.label,
      level: 1,
      xp: 0,
      atk: ADMIN_PET.atk,
      luck: ADMIN_PET.luck
    };
    if (!hasPetType(player, ADMIN_PET.key)) {
      player.pets.push(pet);
    }
    if (player.activePetIndex === -1) {
      player.activePetIndex = player.pets.length - 1;
    } else {
      const idx = player.pets.findIndex(p => p.type === ADMIN_PET.key);
      if (idx !== -1) player.activePetIndex = idx;
    }
    player.pet = player.pets[player.activePetIndex];
    return pet;
  }
}

function gainPetXP(player, amount) {
  ensurePet(player);
  if (!player.pets.length) return;
  const idx = player.activePetIndex;
  if (idx < 0 || idx >= player.pets.length) return;
  const pet = player.pets[idx];
  if (typeof pet.xp !== "number") pet.xp = 0;
  pet.xp += amount;
}
/* --- GÃ¶rev havuzu --- */
const QUEST_POOL = [
  {
    key: "slotPlay",
    desc: "BugÃ¼n en az 3 kez slot oyna",
    target: 3,
    reward: { chips: 3000 }
  },
  {
    key: "rouletteWin",
    desc: "BugÃ¼n rulette 1 kez kazan",
    target: 1,
    reward: { chips: 4500 }
  },
  {
    key: "bjPlay",
    desc: "BugÃ¼n 2 el blackjack oyna",
    target: 2,
    reward: { chips: 3750 }
  },
  {
    key: "dailyClaim",
    desc: "BugÃ¼nkÃ¼ gÃ¼nlÃ¼k Ã¶dÃ¼lÃ¼nÃ¼ al",
    target: 1,
    reward: { chips: 1750 }
  },
  {
    key: "huntTimes",
    desc: "BugÃ¼n 5 kez .hunt yap",
    target: 5,
    reward: { chips: 3750 }
  },
  {
    key: "boxOpen",
    desc: "BugÃ¼n 2 kutu aÃ§",
    target: 2,
    reward: { chips: 4500 }
  }
];

function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function ensureQuests(player) {
  const today = localDateKey();
  if (
    !player.quests ||
    player.quests.date !== today ||
    !Array.isArray(player.quests.activeKeys) ||
    player.quests.activeKeys.length === 0
  ) {
    const allKeys = QUEST_POOL.map(q => q.key);
    const shuffled = shuffleArray(allKeys);
    const active = shuffled.slice(0, 3);
    player.quests = {
      date: today,
      activeKeys: active,
      progress: {},
      completed: {}
    };
  }
}

function applyQuestProgress(player, key, amount) {
  if (!amount || amount <= 0) return;
  ensureQuests(player);
  const qState = player.quests;
  if (!qState.activeKeys.includes(key)) return;

  const def = QUEST_POOL.find(q => q.key === key);
  if (!def) return;

  const prev = qState.progress[key] || 0;
  const now = prev + amount;
  qState.progress[key] = now;

  if (!qState.completed[key] && now >= def.target) {
    qState.completed[key] = true;
    const rewardChips = def.reward?.chips || 0;
    if (rewardChips > 0) {
      player.stack += rewardChips;
    }
  }
}

/* --- Unvanlar --- */
const TITLE_DEFS = [
  {
    key: "yeni_maceraci",
    name: "ğŸ†• Yeni MaceracÄ±",
    desc: "Oyuna katÄ±ldÄ±n.",
    check: (p) => !!p.joined
  },
  {
    key: "zengin_oyuncu",
    name: "ğŸ’° Zengin Oyuncu",
    desc: "Bakiyen 50.000 Ã§ipi geÃ§ti.",
    check: (p) => p.stack >= 50000
  },
  {
    key: "slot_ustasi",
    name: "ğŸ° Slot UstasÄ±",
    desc: "Slotta toplam +10.000 Ã§ip net kazandÄ±n.",
    check: (p) => (p.stats?.slotNetWin || 0) >= 10000
  },
  {
    key: "rulet_ustasi",
    name: "ğŸ¡ Rulet UstasÄ±",
    desc: "Rulette 10 kez kazandÄ±n.",
    check: (p) => (p.stats?.rouletteWins || 0) >= 10
  },
  {
    key: "bj_efsanesi",
    name: "ğŸƒ Blackjack Efsanesi",
    desc: "Blackjack'te 20 kez kazandÄ±n.",
    check: (p) => (p.stats?.bjWins || 0) >= 20
  },
  {
    key: "sadik_oyuncu",
    name: "ğŸ“… SadÄ±k Oyuncu",
    desc: "7 farklÄ± gÃ¼nde gÃ¼nlÃ¼k Ã¶dÃ¼l aldÄ±n.",
    check: (p) => (p.stats?.dailyDays || 0) >= 7
  },
  {
    key: "yeni_avci",
    name: "ğŸª¶ Yeni AvcÄ±",
    desc: "En az 1 kez .hunt yaptÄ±n.",
    check: (p) => (p.stats?.huntCount || 0) >= 1
  },
  {
    key: "usta_avci",
    name: "ğŸ¦´ Usta AvcÄ±",
    desc: "100 kez .hunt yaptÄ±n.",
    check: (p) => (p.stats?.huntCount || 0) >= 100
  },
  {
    key: "kutu_delisi",
    name: "ğŸ Kutu Delisi",
    desc: "50 kutu aÃ§tÄ±n.",
    check: (p) => (p.stats?.boxesOpened || 0) >= 50
  },
  {
    key: "pet_sahibi",
    name: "ğŸ¾ Pet Sahibi",
    desc: "Ä°lk petini aldÄ±n.",
    check: (p) => !!(p.pet || (p.pets && p.pets.length > 0))
  },
  {
    key: "owo_efsanesi",
    name: "ğŸŒ€ OwO Efsanesi",
    desc: "BirÃ§ok unvan aÃ§tÄ±n.",
    check: (p) => (p.titles?.owned?.length || 0) >= 5
  },
  {
    key: "admin_lord",
    name: "ğŸ‘‘ Sunucu Lordu",
    desc: "YÃ¶neticiye Ã¶zel prestij unvanÄ±.",
    check: (_p) => false
  }
];

function ensureTitles(player) {
  if (!player.titles || typeof player.titles !== "object") {
    player.titles = { owned: [], activeKey: null };
  } else {
    if (!Array.isArray(player.titles.owned)) player.titles.owned = [];
    if (typeof player.titles.activeKey !== "string" && player.titles.activeKey !== null) {
      player.titles.activeKey = null;
    }
  }
}

function getOwnedTitleObjects(player) {
  ensureTitles(player);
  return TITLE_DEFS.filter(def => player.titles.owned.includes(def.key));
}

function getActiveTitleName(player) {
  if (!player.titles || !player.titles.activeKey) return null;
  const def = TITLE_DEFS.find(d => d.key === player.titles.activeKey);
  return def ? def.name : null;
}

/* --- Kristal & profil temasÄ± iÃ§in helper --- */
function ensureCrystalsAndSkins(player) {
  if (typeof player.crystals !== "number") player.crystals = 0;
  if (!Array.isArray(player.profileSkins)) player.profileSkins = ["default"];
  if (!player.profileSkins.includes("default")) player.profileSkins.unshift("default");
  if (typeof player.activeProfileSkin !== "string" || !PROFILE_SKINS[player.activeProfileSkin]) {
    player.activeProfileSkin = "default";
  }
}

/* ===== Oyuncu yapÄ±sÄ± ===== */
function getPlayer(id, name) {
  if (!db.data.players[id]) {
    db.data.players[id] = {
      name,
      stack: STARTING_STACK,
      lastDaily: "",
      locked: false,
      joined: false,
      stats: undefined,
      quests: undefined,
      titles: undefined,
      inv: undefined,
      pets: undefined,
      activePetIndex: undefined,
      pet: undefined,
      specialPityUsed: false,
      crystals: 0,
      profileSkins: ["default"],
      activeProfileSkin: "default"
    };
  } else {
    const p = db.data.players[id];
    if (name && !p.name) p.name = name;
    if (typeof p.joined !== "boolean") p.joined = false;
    if (typeof p.locked !== "boolean") p.locked = false;
    if (typeof p.stack !== "number") p.stack = STARTING_STACK;
    if (typeof p.lastDaily !== "string") p.lastDaily = "";
    if (typeof p.specialPityUsed !== "boolean") p.specialPityUsed = false;
  }
  const p = db.data.players[id];
  ensureStats(p);
  ensureQuests(p);
  ensureTitles(p);
  ensureInventory(p);
  ensurePet(p);
  ensureCrystalsAndSkins(p);
  return p;
}

async function checkAndUnlockTitles(msg, player) {
  ensureStats(player);
  ensureTitles(player);
  ensurePet(player);
  const newly = [];
  for (const def of TITLE_DEFS) {
    if (def.check(player) && !player.titles.owned.includes(def.key)) {
      player.titles.owned.push(def.key);
      newly.push(def);
    }
  }
  if (newly.length > 0) {
    await saveDB();
    const lines = newly.map(d => `â€¢ ${d.name} â€” ${d.desc}`);
    if (msg) {
      await msg.reply(
`ğŸ– *Yeni Unvan(lar) KazandÄ±n!*

${lines.join("\n")}

Aktif unvanÄ±nÄ± deÄŸiÅŸtirmek iÃ§in:
.unvan â€” Unvan listesi
.unvan set <numara> â€” Unvan seÃ§`
      );
    }
  }
}

/* ===== OwO tarzÄ± Ã¶ÄŸretici metni ===== */
const OWO_HELP =
`ğŸ¾ *OwO TarzÄ± Oyun Sistemi Nedir?*

Bu bot, Discord'daki OwO botundan esinlenmiÅŸ bir *ekonomi ve mini oyun* sistemidir.
AmaÃ§: Ã§ip biriktirmek, oyunlar oynayÄ±p kazanmak, gÃ¼nlÃ¼k gÃ¶revleri tamamlayÄ±p *unvanlar*, *petler* ve ÅŸimdi de *kristaller* + *profil temalarÄ±* toplamaktÄ±r.

ğŸ® *Temel Komutlar*
â€¢ .join â€” Oyuna katÄ±l, baÅŸlangÄ±Ã§ Ã§ipini al
â€¢ .bakiye â€” Bakiyeni ve aktif unvanÄ±nÄ± gÃ¶r
â€¢ .profil â€” Genel profilini, kristalini ve seÃ§ili temasÄ±nÄ± gÃ¶r
â€¢ .stats â€” KiÅŸisel istatistiklerini gÃ¶sterir
â€¢ .stats all â€” TÃ¼m oyuncularÄ±n genel (global) istatistiklerini gÃ¶sterir
â€¢ .seviye â€” Seviyeni ve XP ilerlemeni gÃ¶r
â€¢ .top seviye â€” En yÃ¼ksek seviyedeki oyuncularÄ± gÃ¶r
â€¢ .gÃ¼nlÃ¼k â€” GÃ¼nlÃ¼k Ã§ip Ã¶dÃ¼lÃ¼nÃ¼ al
â€¢ .slot <miktar> â€” Slot makinesi oynarsÄ±n
â€¢ .rulet <miktar> <seÃ§im> â€” Rulet oynarsÄ±n (Ã¶rn: .rulet 100 kÄ±rmÄ±zÄ±)
â€¢ .bj <miktar> â€” Blackjack oyunu baÅŸlatÄ±r
â€¢ .hunt â€” Avlan, Ã§ip ve kutu bul (pet bonuslarÄ±yla daha da gÃ¼Ã§lÃ¼)
â€¢ .kutu â€” Elindeki kutularÄ± aÃ§ (artÄ±k kristal de dÃ¼ÅŸebilir)
â€¢ .kutu all â€” TÃ¼m kutularÄ± tek seferde aÃ§
â€¢ .gÃ¶rev â€” BugÃ¼ne Ã¶zel rastgele 3 gÃ¶revi gÃ¶sterir
â€¢ .unvan â€” UnvanlarÄ±nÄ± listele / seÃ§
â€¢ .pet â€” Pet sistemini ve petini yÃ¶net
â€¢ .pet shop â€” Pet fiyatlarÄ±nÄ± *Ã§ip + kristal* olarak gÃ¶r
â€¢ .kristal â€” Toplam kristalini gÃ¶r, kristali Ã§ipe dÃ¶nÃ¼ÅŸtÃ¼r
â€¢ .profilskin â€” Profil temalarÄ±nÄ± listele / satÄ±n al / seÃ§
â€¢ .owo â€” Bu rehberi tekrar gÃ¶sterir

ğŸ’ *Kristal Sistemi*

â€¢ Kutu aÃ§arken az ihtimalle *kristal* dÃ¼ÅŸer (1â€“3 arasÄ±).
â€¢ Etkinlik buffâ€™Ä± (.eventbuff) aÃ§Ä±kken kristal drop oranÄ± artar.
â€¢ Kristaller Ã§ok deÄŸerli bir para birimidir:
  - Pet satÄ±n alÄ±rken Ã§ip yerine kristal kullanabilirsin.
  - .kristal bozdur <miktar> ile kristali Ã§ipe Ã§evirebilirsin.
  - Profil temalarÄ± (Nadir / Efsanevi) kristalle satÄ±n alÄ±nÄ±r.

ğŸ“¦ *Kutu & Ã–zel Pet Drop OranlarÄ±*
Kutu aÃ§arken:
â€¢ Normal Ã§ip Ã¶dÃ¼lleri + pet bonuslarÄ± + buff bonusu
â€¢ DÃ¼ÅŸÃ¼k ihtimalle Ã¶zel petler:
  - ğŸ¢ KaplumbaÄŸa
  - ğŸŒ Salyangoz
  - ğŸ¨ Koala
â€¢ AynÄ± zamanda az ihtimalle 1â€“3 *kristal* dÃ¼ÅŸebilir.

ğŸ–¼ï¸ *Profil TemalarÄ±*
â€¢ .profilskin list â€” Sahip olduÄŸun ve satÄ±n alabileceÄŸin temalarÄ± gÃ¶sterir.
â€¢ Temalar:
  - Standart Profil (SÄ±radan, Ã¼cretsiz)
  - Neon Oyuncu (Nadir, kristal ile)
  - Efsane GÃ¶steriÅŸ (Efsanevi, kristal ile)
  - ğŸ‘‘ YÃ¶netici TahtÄ± (Sadece adminlere Ã¶zel)
â€¢ .profilskin al <tema>
â€¢ .profilskin set <tema>

ğŸ¾ *Pet Sistemi (Ã‡oklu Pet)*

ArtÄ±k birden fazla pet alabilirsin! Petlerin hem Ã§ip hem kristal fiyatÄ± vardÄ±r.
Ã‡ipin yetmiyorsa kristalle alabilir, ya da kristalini Ã§ipe Ã§evirebilirsin.

SatÄ±n alÄ±nabilen pet Ã¶rnekleri (kÃ¼Ã§Ã¼kten bÃ¼yÃ¼ÄŸe):
â€¢ ğŸ¦— Ã‡ekirge â€” 6000 Ã§ip | ~15 kristal
â€¢ ğŸœ Karinca â€” 8000 Ã§ip | ~18 kristal
â€¢ ğŸ¼ Panda â€” 16000 Ã§ip | ~35 kristal
â€¢ ğŸ KeÃ§i â€” 24000 Ã§ip | ~45 kristal
â€¢ ğŸ´ At â€” 30000 Ã§ip | ~55 kristal
â€¢ ...

Kutudan Ã§Ä±kan Ã¶zel petler (artÄ±k kristalle de alÄ±nabilir):
â€¢ ğŸ¢ KaplumbaÄŸa (Koleksiyon)
â€¢ ğŸŒ Salyangoz (Ã–zel) â€” Hunt drop ÅŸansÄ±nÄ± arttÄ±rÄ±r.
â€¢ ğŸ¨ Koala (Efsane) â€” Bot aÃ§Ä±kken her 30 dakikada bir +3000 Ã§ip pasif gelir kazandÄ±rÄ±r.

Komutlar:
â€¢ .pet â€” Aktif petini ve Ã¶zetini gÃ¶sterir
â€¢ .pet al <tÃ¼r> â€” Pet satÄ±n al (Ã§ip veya kristal)
â€¢ .pet liste â€” TÃ¼m sahip olduÄŸun petleri listele
â€¢ .pet set <numara> â€” Listeden bir peti *aktif* yap
â€¢ .pet isim <yeni_ad> â€” Aktif petine isim ver
â€¢ .pet shop â€” TÃ¼m petleri ve fiyatlarÄ±nÄ± gÃ¶r

ğŸ“œ *GÃ¼nlÃ¼k GÃ¶revler*
â€¢ .gÃ¶rev â€” BugÃ¼ne Ã¶zel rastgele gÃ¶revler:
  - 3 kez slot oyna
  - 2 el blackjack oyna
  - 5 kez .hunt yap
  - 2 kutu aÃ§
  GÃ¶revler tamamlanÄ±nca otomatik Ã§ip Ã¶dÃ¼lÃ¼ eklenir.

ğŸ– *Unvan Sistemi*
â€¢ OynadÄ±kÃ§a sistem seni takip eder ve otomatik unvan aÃ§arsÄ±n:
  - ğŸ†• Yeni MaceracÄ±
  - ğŸ’° Zengin Oyuncu
  - ğŸ° Slot UstasÄ±
  - ğŸ¡ Rulet UstasÄ±
  - ğŸƒ Blackjack Efsanesi
  - ğŸª¶ Yeni AvcÄ± / ğŸ¦´ Usta AvcÄ±
  - ğŸ Kutu Delisi
  - ğŸ¾ Pet Sahibi
  - ğŸ“… SadÄ±k Oyuncu

â€¢ .unvan â€” UnvanlarÄ±nÄ± listele
â€¢ .unvan set <numara> â€” Aktif olarak gÃ¶stermek istediÄŸin unvanÄ± seÃ§

ğŸ‘‘ *YÃ¶netici Ã–zel*
â€¢ .pet adminkurt â†’ Adminâ€™e Ã¶zel Alfa Kurt peti (ATK/LUCK 999)
â€¢ .unvan admin â†’ Adminâ€™e Ã¶zel Sunucu Lordu unvanÄ±nÄ± aÃ§ar
â€¢ .eventbuff â†’ 15 dk boyunca hunt & kutu kazancÄ± + kristal drop oranÄ±nÄ± arttÄ±ran etkinlik baÅŸlatÄ±r
â€¢ .profilskin admin â†’ Adminâ€™e Ã¶zel profil temasÄ±nÄ± (ğŸ‘‘ YÃ¶netici TahtÄ±) aÃ§ar

ğŸ’¡ *Taktik*
Her gÃ¼n:
1) .join (bir kereye mahsus)
2) .gÃ¼nlÃ¼k al
3) .slot / .rulet / .bj / .hunt ile oyna
4) .kutu veya .kutu all ile kutularÄ± aÃ§ (kristal + Ã¶zel pet ÅŸansÄ±)
5) .kristal ile ister pet al, ister Ã§ipe Ã§evir
6) .profilskin ile kendine bir tema seÃ§
7) .unvan ile havalÄ± unvanÄ±nÄ± seÃ§ ğŸ˜`;
/* --- Oyuna katÄ±lÄ±m ÅŸartÄ± kontrolÃ¼ --- */
async function requireJoined(msg, player) {
  if (player.joined) return true;
  await msg.reply("ğŸŸ Oyuna katÄ±lmak iÃ§in `.join` yaz.");
  return false;
}

/* --- Mesaj sahibine gÃ¶re stabil oyun anahtarÄ± Ã¼retir --- */
function makeGameKey(msg, s) {
  const chat = (msg.from || "").split("@")[0];
  const author = (msg.author || "").split("@")[0];
  if (s.phoneId) return `p:${s.phoneId}`;
  if (author)  return `g:${chat}:${author}`;
  return `c:${chat}`;
}

/* ====== LID uyumlu gÃ¶nderen Ã§Ã¶zÃ¼mleyici ====== */
async function resolveSender(msg) {
  const authorId = msg.author || "";
  const fromId   = msg.from   || "";
  const authorUser = authorId.split("@")[0];
  const fromUser   = fromId.split("@")[0];
  const contact = await msg.getContact().catch(() => null);
  let number = null;
  try { number = contact && (await contact.getNumber?.()); } catch {}
  const widUser = contact?.id?.user || null;
  const phoneCandidate = number || widUser || null;
  const lidCandidate   = authorUser || fromUser || null;
  return {
    phoneId: phoneCandidate ? normPhone(phoneCandidate) : null,
    phoneIdLast10: phoneCandidate ? phoneCandidate.replace(/\D/g, "").slice(-10) : null,
    lid: lidCandidate || null
  };
}

/* ====== Tek hedef Ã§Ã¶zÃ¼cÃ¼ ====== */
const samePerson = (a, b) => last10(a) === last10(b);

async function resolveSingleTarget(msg) {
  const foundMentions = [];
  const foundReply = [];
  const foundNumbers = [];
  const foundInternal = [];

  // @mentionâ€™lardan
  try {
    const mentions = (await msg.getMentions?.()) || [];
    for (const c of mentions) {
      let n = null;
      try { n = await c.getNumber?.(); } catch {}
      const u = c?.id?.user || null;
      const cand = n || u;
      if (cand) {
        const pn = normPhone(cand);
        if (!foundMentions.some(x => samePerson(x, pn))) foundMentions.push(pn);
      }
    }
  } catch {}

  // YanÄ±tlanan mesajdan
  try {
    const quoted = await msg.getQuotedMessage?.();
    if (quoted) {
      const qc = await quoted.getContact?.();
      let qn = null;
      try { qn = await qc.getNumber?.(); } catch {}
      const qu = qc?.id?.user || null;
      const cand = qn || qu;
      if (cand) {
        const pn = normPhone(cand);
        if (!foundReply.some(x => samePerson(x, pn))) foundReply.push(pn);
      }
    }
  } catch {}

  // Mesaj iÃ§indeki numaralardan
  const words = (msg.body || "").split(/\s+/);
  for (const w of words) {
    const d = (w || "").replace(/\D/g, "");
    if (d.length >= 10 && d.length <= 15) {
      const pn = normPhone(d);
      if (!foundNumbers.some(x => samePerson(x, pn))) foundNumbers.push(pn);
    }
  }

  // Ä°Ã§ mentionedIds alanÄ±ndan
  try {
    const raw = msg?._data?.mentionedIds || msg?.mentionedIds || [];
    for (const r of raw) {
      const u = String(r).split("@")[0];
      if (u) {
        const pn = normPhone(u);
        if (!foundInternal.some(x => samePerson(x, pn))) foundInternal.push(pn);
      }
    }
  } catch {}

  const pickUnique = (arr) => {
    const out = [];
    for (const p of arr) if (!out.some(x => samePerson(x, p))) out.push(p);
    return out;
  };

  const m = pickUnique(foundMentions);
  if (m.length === 1) return { ok: true, id: m[0] };
  if (m.length > 1) return { ok: false, reason: "multi", message: `âš ï¸ Birden fazla kiÅŸi algÄ±landÄ± (${m.map(x => last10(x)).join(", ")}). LÃ¼tfen *tek* bir kiÅŸi belirt.` };

  const r = pickUnique(foundReply);
  if (r.length === 1) return { ok: true, id: r[0] };
  if (r.length > 1) return { ok: false, reason: "multi", message: `âš ï¸ Birden fazla kiÅŸi algÄ±landÄ± (${r.map(x => last10(x)).join(", ")}). LÃ¼tfen *tek* bir kiÅŸi belirt.` };

  const n = pickUnique(foundNumbers);
  if (n.length === 1) return { ok: true, id: n[0] };
  if (n.length > 1) return { ok: false, reason: "multi", message: `âš ï¸ Birden fazla kiÅŸi algÄ±landÄ± (${n.map(x => last10(x)).join(", ")}). LÃ¼tfen *tek* bir kiÅŸi belirt.` };

  const i = pickUnique(foundInternal);
  if (i.length === 1) return { ok: true, id: i[0] };
  if (i.length > 1) return { ok: false, reason: "multi", message: `âš ï¸ Birden fazla kiÅŸi algÄ±landÄ± (${i.map(x => last10(x)).join(", ")}). LÃ¼tfen *tek* bir kiÅŸi belirt.` };

  return {
    ok: false,
    reason: "none",
    message: "âš ï¸ Hedef bulunamadÄ±. *Tek* bir @kiÅŸi etiketle, numarasÄ±nÄ± yaz ya da kiÅŸinin mesajÄ±nÄ± *yanÄ±tlayarak* gÃ¶nder."
  };
}

/* ====== Mentionâ€™lardan toplu Ã§Ä±karÄ±cÄ± ====== */
function onlyDigits(s){ return (s||"").replace(/\D/g,""); }

async function extractMentionedIds(msg) {
  try {
    const contacts = (await msg.getMentions?.()) || [];
    const fromMentions = await Promise.all(contacts.map(async (c) => {
      let n = null;
      try { n = await c.getNumber?.(); } catch {}
      const u = c?.id?.user || null;
      const cand = n || u;
      return cand ? normPhone(cand) : null;
    }));
    const mentionIds = fromMentions.filter(Boolean);
    const raw = (msg.body || "")
      .split(/\s+/)
      .filter(w => /^\d{10,15}$/.test(onlyDigits(w)))
      .map(w => normPhone(w));
    return Array.from(new Set([...mentionIds, ...raw]));
  } catch {
    return [];
  }
}

/* ==================== Dedupe ==================== */
const SEEN = new Set();
function shouldProcess(msg) {
  const key = msg?.id?._serialized || msg?.id?.id || `${msg.timestamp}:${msg.from}`;
  if (SEEN.has(key)) return false;
  SEEN.add(key);
  setTimeout(() => SEEN.delete(key), 60_000);
  return true;
}

/* ==== Transfer dedupe ==== */
const DONE_TX = new Set();

/* ==================== Oyun Durumu & YardÄ±mcÄ±lar ==================== */
const animations = ["ğŸ‚ ğŸ’«", "ğŸƒâœ¨", "ğŸ’¥ğŸ‚¡", "ğŸ´ğŸŒ€", "ğŸ’«ğŸ‚±", "ğŸª„ğŸ‚¾", "ğŸ’¨ğŸƒ", "ğŸ‚«ğŸ”¥"];
const games = {};

const suits = ["â™ ï¸", "â™¥ï¸", "â™¦ï¸", "â™£ï¸"];
const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];

function drawCard() {
  const suit = suits[Math.floor(Math.random() * suits.length)];
  const value = values[Math.floor(Math.random() * values.length)];
  return { suit, value };
}

function getHandValue(hand) {
  let value = 0, aces = 0;
  for (const card of hand) {
    if (["J", "Q", "K"].includes(card.value)) value += 10;
    else if (card.value === "A") { value += 11; aces++; }
    else value += parseInt(card.value, 10);
  }
  while (value > 21 && aces > 0) { value -= 10; aces--; }
  return value;
}

function suitDot(suit) { return (suit === "â™¥ï¸" || suit === "â™¦ï¸") ? "ğŸ”´" : "âš«"; }
function handToDotString(hand) { return hand.map(c => `${c.value}${suitDot(c.suit)}`).join(" "); }
function valueText(val) { return (val > 21) ? "BUST! ğŸ’¥" : String(val); }

/* ===== Grup yardÄ±mcÄ±larÄ± ===== */
async function isGroupAdminByMsg(msg) {
  const chat = await msg.getChat();
  if (!chat.isGroup) return { isGroup: false, isGroupAdmin: false, chat };
  const senderId = msg.author || (await msg.getContact())?.id?._serialized;
  const isGroupAdmin = (chat.participants || []).some(p =>
    p.isAdmin && (p.id?._serialized === senderId)
  );
  return { isGroup: true, isGroupAdmin, chat };
}

/* ========== YardÄ±m metni ========== */
function buildHelpText(isAdmin) {
  const userPart =
`â™£ï¸ *Komutlar*
â€¢ .join â€” Oyuna katÄ±l
â€¢ .bakiye â€” Bakiyeni gÃ¶sterir
â€¢ .profil â€” Profilini, kristalini ve istatistiklerini gÃ¶sterir
â€¢ .seviye â€” Seviye ve XP ilerlemeni gÃ¶sterir
â€¢ .top seviye â€” En yÃ¼ksek seviyedeki oyuncularÄ± gÃ¶sterir
â€¢ .gÃ¼nlÃ¼k â€” GÃ¼nlÃ¼k Ã¶dÃ¼l
â€¢ .score â€” Skor tablosu
â€¢ .slot <miktar> â€” Slot
â€¢ .bj <miktar> | .bj bet <miktar> â€” Blackjack
â€¢ .rulet <miktar> <seÃ§im> â€” Rulet (Ã¶rn: .rulet 100 kÄ±rmÄ±zÄ±)
â€¢ .hunt â€” Avlan, Ã§ip ve kutu kazan (3 sn bekleme)
â€¢ .kutu â€” Elindeki kutularÄ± aÃ§ (kristal + Ã¶zel pet ÅŸansÄ±)
â€¢ .kutu all â€” TÃ¼m kutularÄ± tek seferde aÃ§
â€¢ .gÃ¶rev â€” GÃ¼nlÃ¼k rastgele gÃ¶revlerini gÃ¶sterir
â€¢ .unvan â€” UnvanlarÄ±nÄ± listele / ayarla
â€¢ .pet â€” Petini gÃ¶r / al / seÃ§
â€¢ .pet liste â€” TÃ¼m petlerini listele
â€¢ .pets â€” TÃ¼m sahip olduÄŸun petleri listele
â€¢ .pet shop â€” Petleri *Ã§ip + kristal* fiyatlarÄ±yla gÃ¶r
â€¢ .kristal â€” Toplam kristalini gÃ¶r ve kristali Ã§ipe dÃ¶nÃ¼ÅŸtÃ¼r
â€¢ .profilskin â€” Profil temalarÄ±nÄ± listele / satÄ±n al / seÃ§
â€¢ .owo â€” OwO tarzÄ± sistemi anlatan rehber

ğŸ® Oyun iÃ§i: .hit | .stand | .db | .sur

â„¹ï¸ Ä°pucu: ".bj" tek baÅŸÄ±na yazÄ±nca kÄ±sayol menÃ¼sÃ¼ gelir. ".rulet" tek baÅŸÄ±na yazÄ±nca rulet yardÄ±mÄ±nÄ±, ".kristal" yazÄ±nca kristal durumunu gÃ¶rÃ¼rsÃ¼n.`;

  const adminPart =
`\n\nğŸ‘‘ *YÃ¶netici KomutlarÄ±*
â€¢ .allpman â€” Herkese +5000
â€¢ .alpman â€” Kendine +15000
â€¢ .max â€” Kendine 999999999999 Ã§ip ekler
â€¢ .listedenat @kiÅŸi â€” Skordan Ã§Ä±kar
â€¢ .bakiye reset @kiÅŸi â€” 0 yap
â€¢ .send <miktar> @kiÅŸi â€” Ã‡ip gÃ¶nder
â€¢ !everyone [mesaj] â€” Gruptaki herkesi etiketle
â€¢ !kilit â€” Sadece yÃ¶neticiler mesaj atabilsin
â€¢ !kilitaÃ§ â€” Herkese tekrar yazma izni
â€¢ .pet adminkurt â€” Adminâ€™e Ã¶zel Alfa Kurt peti (ATK/LUCK 999)
â€¢ .unvan admin â€” Adminâ€™e Ã¶zel Sunucu Lordu unvanÄ±nÄ± aÃ§ar
â€¢ .eventbuff â€” Hunt & kutu iÃ§in geÃ§ici etkinlik buffâ€™Ä± + kristal drop artÄ±ÅŸÄ± baÅŸlatÄ±r
â€¢ .profilskin admin â€” Adminâ€™e Ã¶zel profil temasÄ±nÄ± (ğŸ‘‘ YÃ¶netici TahtÄ±) aÃ§ar`;

  return isAdmin ? (userPart + adminPart) : userPart;
}
/* ==================== SLOT & JACKPOT ==================== */
const symbols = ["ğŸ’", "ğŸ‹", "ğŸ‰", "ğŸ‡", "ğŸ¥", "ğŸ€", "â­"];
const paytable = { "ğŸ’": 2, "ğŸ‹": 3, "ğŸ‰": 4, "ğŸ‡": 5, "ğŸ¥": 6, "ğŸ€": 8, "â­": 12 };
let jackpot = 5000;

function spinSlot() {
  const grid = Array.from({ length: 3 }, () =>
    Array.from({ length: 3 }, () => symbols[Math.floor(Math.random() * symbols.length)])
  );
  return grid;
}

function checkSlotWin(grid, bet) {
  let totalWin = 0;
  const lines = [];
  for (let r = 0; r < 3; r++) {
    if (grid[r][0] === grid[r][1] && grid[r][1] === grid[r][2]) {
      const sym = grid[r][0];
      const win = bet * paytable[sym];
      totalWin += win;
      lines.push(`â­ SatÄ±r ${r + 1}: ${sym}${sym}${sym} â†’ +${win}`);
      if (sym === "â­") {
        totalWin += jackpot;
        lines.push(`ğŸ’¥ğŸ’° JACKPOT! +${jackpot} Ã‡ip!`);
        jackpot = 5000;
      }
    }
  }
  if (totalWin === 0) jackpot += Math.floor(bet * 0.2);
  return { totalWin, lines };
}

/* ==================== RULET ==================== */
const ROULET_HELP =
`ğŸ¡ *RULET Ã–ÄRETÄ°CÄ°SÄ°* ğŸ¡

Rulet oynamak iÃ§in komut:
.rulet <miktar> <seÃ§im>

ğŸ”¢ 1) Miktar Nedir?
â€¢ Oyun iÃ§in kaÃ§ Ã§iple bahis yapacaÄŸÄ±nÄ± gÃ¶sterir.

ğŸ¯ 2) SeÃ§im Nedir?
Renk / tek-Ã§ift / 1-18 / 19-36 / dÃ¼zineler veya direkt sayÄ± (0â€“36) seÃ§ebilirsin.

ğŸ“Œ Ã–rnekler:
â€¢ .rulet 100 kÄ±rmÄ±zÄ±
â€¢ .rulet 200 tek
â€¢ .rulet 150 1-12
â€¢ .rulet 50 17
â€¢ .rulet 100 0`;

const REDS = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);

function rouletteColor(n) {
  if (n === 0) return { name: "yeÅŸil", dot: "ğŸŸ¢" };
  if (REDS.has(n)) return { name: "kÄ±rmÄ±zÄ±", dot: "ğŸ”´" };
  return { name: "siyah", dot: "âš«" };
}

function rouletteSpin() {
  return Math.floor(Math.random() * 37);
}

function parseRoulettePick(rawTokens){
  const raw = normalizeTR(rawTokens.join(" "));
  if (!raw) return { ok:false, message: "KullanÄ±m: .rulet <miktar> <secim>. Ã–rn: .rulet 100 kirmizi" };
  const t = raw;

  const num = parseInt(t, 10);
  if (Number.isFinite(num) && num >= 0 && num <= 36) {
    return {
      ok: true, kind: "number", title: `SayÄ± ${num}`,
      test: (n)=> n === num, payout: 35
    };
  }

  if (["k","kirmizi","red"].includes(t)) {
    return { ok:true, kind:"color:red", title:"KÄ±rmÄ±zÄ±", test:(n)=> n!==0 && REDS.has(n), payout:1 };
  }
  if (["s","siyah","black"].includes(t)) {
    return { ok:true, kind:"color:black", title:"Siyah", test:(n)=> n!==0 && !REDS.has(n), payout:1 };
  }

  if (["tek","odd"].includes(t)) {
    return { ok:true, kind:"odd", title:"Tek", test:(n)=> n!==0 && n%2===1, payout:1 };
  }
  if (["cift","cif","even"].includes(t)) {
    return { ok:true, kind:"even", title:"Ã‡ift", test:(n)=> n!==0 && n%2===0, payout:1 };
  }

  if (["1-18","alt","low"].includes(t)) {
    return { ok:true, kind:"low", title:"1-18", test:(n)=> n>=1 && n<=18, payout:1 };
  }
  if (["19-36","ust","high","yuksek"].includes(t)) {
    return { ok:true, kind:"high", title:"19-36", test:(n)=> n>=19 && n<=36, payout:1 };
  }

  if (["1-12","d1","duzin1","duzine1"].includes(t)) {
    return { ok:true, kind:"dozen1", title:"1-12", test:(n)=> n>=1 && n<=12, payout:2 };
  }
  if (["13-24","d2","duzin2","duzine2"].includes(t)) {
    return { ok:true, kind:"dozen2", title:"13-24", test:(n)=> n>=13 && n<=24, payout:2 };
  }
  if (["25-36","d3","duzin3","duzine3"].includes(t)) {
    return { ok:true, kind:"dozen3", title:"25-36", test:(n)=> n>=25 && n<=36, payout:2 };
  }

  return { ok:false, message:
`âš ï¸ GeÃ§ersiz seÃ§im.
Ã–rnekler:
â€¢ .rulet 100 kÄ±rmÄ±zÄ±
â€¢ .rulet 200 tek
â€¢ .rulet 150 1-12
â€¢ .rulet 50 17
â€¢ .rulet 100 0` };
}

/* ==================== WhatsApp Client ==================== */
const client = new Client({
  authStrategy: new LocalAuth(),
  puppeteer: { headless: true, args: ["--no-sandbox", "--disable-setuid-sandbox", "--disable-dev-shm-usage"] }
});

client.on("qr", qr => qrcode.generate(qr, { small: true }));
client.on("ready", () => console.log("âœ… Bot aktif!"));
client.on("auth_failure", m => console.error("âŒ Kimlik doÄŸrulama hatasÄ±:", m));
client.on("disconnected", r => console.warn("âš ï¸ BaÄŸlantÄ± koptu:", r));

/* ==================== Ortak: Admin kontrol ==================== */
function isAdminCheck(sender) {
  const fileAdmins = readAdmins();
  const phonePool = [
    ...ADMIN_PHONES,
    ...(fileAdmins.phones || []).map(normPhone)
  ];
  if (sender.phoneId) {
    const p = sender.phoneId;
    const p10 = sender.phoneIdLast10;
    if (phonePool.some(ap => ap === p || last10(ap) === p10)) return true;
  }
  if (sender.lid) {
    if ((fileAdmins.lids || []).includes(sender.lid)) return true;
  }
  return false;
}

/* ===== Hunt cooldown (3 saniye) ===== */
const HUNT_COOLDOWN_MS = 3000;
const lastHuntTimes = {}; // keyId -> ms
 
/* ===== Slot cooldown (3 saniye) ===== */
const SLOT_COOLDOWN_MS = 3000;
const lastSlotTimes = {}; // keyId -> ms

/* ===== Kutu Ã¶zel pet drop oranlarÄ± ===== */
const SPECIAL_DROP_RATES = {
  koala: 0.001,       // %0.1
  salyangoz: 0.002,   // %0.2
  kaplumbaga: 0.003   // %0.3
};

/* ===== Koala pasif gelir sistemi ===== */
const KOALA_PASSIVE_INTERVAL_MS = 30 * 60 * 1000; // 30 dakika
const KOALA_PASSIVE_AMOUNT = 3000;

setInterval(async () => {
  try {
    if (!db.data || !db.data.players) return;
    let affected = 0;
    for (const player of Object.values(db.data.players)) {
      ensurePet(player);
      if (hasPetType(player, "koala")) {
        player.stack += KOALA_PASSIVE_AMOUNT;
        affected++;
      }
    }
    if (affected > 0) {
      await saveDB();
      console.log(`ğŸ¨ Koala pasif geliri: ${affected} oyuncuya +${KOALA_PASSIVE_AMOUNT} Ã§ip verildi.`);
    }
  } catch (err) {
    console.error("Koala pasif gelir hatasÄ±:", err);
  }
}, KOALA_PASSIVE_INTERVAL_MS);
/* ==================== KRÄ°STAL & PROFÄ°L TEMA SÄ°STEMÄ° ==================== */

/* 1 kristalin Ã§ip deÄŸeri (dÃ¶nÃ¼ÅŸtÃ¼rme iÃ§in) */
const CRYSTAL_TO_CHIP_RATE = 2500; // 1 ğŸ’ = 2500 Ã§ip

/* Kutu aÃ§arken kristal Ã§Ä±kma ihtimali */
const BASE_CRYSTAL_DROP_CHANCE = 0.08; // %8 temel
const EVENTBUFF_CRYSTAL_BONUS   = 0.07; // etkinlikte +%7

/* Petlerin kristal fiyatlarÄ± (Ã¶zel petler dahil) */
const PET_CRYSTAL_PRICES = {
  cekirge: 5,
  karinca: 8,
  panda: 15,
  keci: 20,
  at: 25,
  zebra: 30,
  kedi: 35,
  tavsan: 40,
  kopek: 45,
  kartal: 60,
  suaygiri: 65,
  fil: 80,
  tilki: 90,
  gergedan: 120,
  cita: 150,
  aslan: 200,
  ejderha: 400,

  // Ã–zel petler â€“ sadece kristal ile alÄ±nabilir
  kaplumbaga: 80,
  salyangoz: 120,
  koala: 220
};

/* Profil temalarÄ± */
const PROFILE_SKINS = {
  default: {
    key: "default",
    name: "Klasik Profil",
    rarity: "Standart",
    crystalCost: 0,
    adminOnly: false,
    description: "VarsayÄ±lan sade gÃ¶rÃ¼nÃ¼m."
  },
  rare_blue: {
    key: "rare_blue",
    name: "Mavi Ã‡erÃ§eve",
    rarity: "Nadir",
    crystalCost: 25,
    adminOnly: false,
    description: "Mavi ÅŸeritler ve temiz gÃ¶rÃ¼nÃ¼m."
  },
  epic_purple: {
    key: "epic_purple",
    name: "Mor Enerji",
    rarity: "Efsanevi",
    crystalCost: 60,
    adminOnly: false,
    description: "Mor vurgular ve gÃ¼Ã§lÃ¼ Ã§erÃ§eve."
  },
  legendary_gold: {
    key: "legendary_gold",
    name: "AltÄ±n Alev",
    rarity: "Mitik",
    crystalCost: 120,
    adminOnly: false,
    description: "AltÄ±n Ã§erÃ§eve ve parÄ±ltÄ±lÄ± baÅŸlÄ±k."
  },
  admin_throne: {
    key: "admin_throne",
    name: "ğŸ‘‘ YÃ¶netici TahtÄ±",
    rarity: "Ã–zel (Admin)",
    crystalCost: 0,
    adminOnly: true,
    description: "Sadece adminlere Ã¶zel prestij profili."
  }
};

/* Oyuncunun kozmetik alanÄ±nÄ± garantiye al */
function ensureCosmetics(player) {
  if (!player.cosmetics || typeof player.cosmetics !== "object") {
    player.cosmetics = {
      skinsOwned: ["default"],
      activeSkin: "default"
    };
  } else {
    if (!Array.isArray(player.cosmetics.skinsOwned)) {
      player.cosmetics.skinsOwned = ["default"];
    }
    if (!player.cosmetics.skinsOwned.includes("default")) {
      player.cosmetics.skinsOwned.unshift("default");
    }
    if (typeof player.cosmetics.activeSkin !== "string") {
      player.cosmetics.activeSkin = "default";
    }
  }
}

/* Aktif skin objesini dÃ¶ndÃ¼r */
function getActiveSkin(player) {
  ensureCosmetics(player);
  const key = player.cosmetics.activeSkin || "default";
  return PROFILE_SKINS[key] || PROFILE_SKINS.default;
}

/* Profil metnini temaya gÃ¶re oluÅŸturan fonksiyon */
function renderProfile(player, isAdmin) {
  ensureStats(player);
  ensureInventory(player);
  ensurePet(player);
  ensureQuests(player);
  ensureCosmetics(player);

  if (typeof player.crystals !== "number") player.crystals = 0;

  const activeTitleName = getActiveTitleName(player) || "Yok";

  let activePetText = "Yok";
  if (player.pet) {
    const petType = player.pet.type || "-";
    const petName = player.pet.name || petType;
    activePetText = `${petName} (${petType})`;
  }

  const qState = player.quests;
  let questLines = [];
  if (qState && Array.isArray(qState.activeKeys) && qState.activeKeys.length) {
    questLines = qState.activeKeys
      .map((key) => {
        const def = QUEST_POOL.find((q) => q.key === key);
        if (!def) return null;
        const prog = (qState.progress && qState.progress[key]) || 0;
        const done = !!(qState.completed && qState.completed[key]);
        const status = done ? "âœ…" : `â³ ${prog}/${def.target}`;
        return `â€¢ ${def.desc} â€” ${status}`;
      })
      .filter(Boolean);
  }

  const questsText = questLines.length
    ? questLines.join("\n")
    : "â€¢ BugÃ¼n iÃ§in gÃ¶rev bulunamadÄ±. Detay iÃ§in .gÃ¶rev yaz.";

  const s = player.stats || {};
  const { level, totalXp } = calculatePlayerLevel(player);
  const skin = getActiveSkin(player);

  const baseBody =
`Ad: ${player.name || "-"}
ğŸ¦ Bakiye: ${player.stack}
ğŸ’ Kristal: ${player.crystals}
ğŸ– Aktif Unvan: ${activeTitleName}
ğŸ¾ Aktif Pet: ${activePetText}
â­ Seviye: ${level} (XP: ${totalXp})

ğŸ“Š *Genel Ä°statistikler*
â€¢ Slot oyunlarÄ±: ${s.slotGames}
â€¢ Slot net kazanÃ§: ${s.slotNetWin}
â€¢ Rulet galibiyetleri: ${s.rouletteWins}/${s.rouletteGames}
â€¢ BJ galibiyetleri: ${s.bjWins}/${s.bjGames}
â€¢ Hunt sayÄ±sÄ±: ${s.huntCount}
â€¢ AÃ§Ä±lan kutu: ${s.boxesOpened}
â€¢ GÃ¼nlÃ¼k alÄ±nan gÃ¼n sayÄ±sÄ±: ${s.dailyDays}

ğŸ“œ *BugÃ¼nkÃ¼ GÃ¶revler*
${questsText}

ğŸ¨ Aktif Tema: ${skin.name} (${skin.rarity})
ğŸ”¹ Tema deÄŸiÅŸtirmek iÃ§in: .profilskin
ğŸ”¹ Pet ve kristal detaylarÄ± iÃ§in: .pet | .kristal`;

  // Admin Ã¶zel profil (KullanÄ±cÄ± seÃ§tiyse ve gerÃ§ekten admin ise)
  if (skin.key === "admin_throne" && isAdmin) {
    return (
`ğŸ‘‘ *${player.name || "-"} â€” YÃ¶netici TahtÄ±* ğŸ‘‘
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ° Unvan: ${activeTitleName}
ğŸ’ Kristal: ${player.crystals}
ğŸ¦ Bakiye: ${player.stack}
ğŸ¾ Aktif Pet: ${activePetText}
â­ Seviye: ${level} (XP: ${totalXp})

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“Š *Genel Ä°statistikler*
â€¢ Slot: ${s.slotGames} el (Net: ${s.slotNetWin})
â€¢ Rulet: ${s.rouletteWins}/${s.rouletteGames}
â€¢ BJ: ${s.bjWins}/${s.bjGames}
â€¢ Hunt: ${s.huntCount} (Toplam kazanÃ§: ${s.huntProfit})
â€¢ AÃ§Ä±lan kutu: ${s.boxesOpened}
â€¢ GÃ¼nlÃ¼k gÃ¼n: ${s.dailyDays}

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“œ *BugÃ¼nkÃ¼ GÃ¶revler*
${questsText}

ğŸ¨ Tema: ${skin.name} (${skin.rarity})
ğŸ“Œ DiÄŸer temalar iÃ§in: .profilskin
ğŸ’ Kristal dÃ¶nÃ¼ÅŸtÃ¼r: .kristal Ã§evir <adet>`
    );
  }

  // DiÄŸer temalar iÃ§in ufak kozmetik farklar
  if (skin.key === "legendary_gold") {
    return (
`âœ¨ğŸŸ¡ *PROFÄ°L â€” ALTIN ALEV* ğŸŸ¡âœ¨

${baseBody}`
    );
  }

  if (skin.key === "epic_purple") {
    return (
`ğŸ’œâš¡ *PROFÄ°L â€” MOR ENERJÄ°* âš¡ğŸ’œ

${baseBody}`
    );
  }

  if (skin.key === "rare_blue") {
    return (
`ğŸ’  *PROFÄ°L â€” MAVÄ° Ã‡ERÃ‡EVE* ğŸ’ 

${baseBody}`
    );
  }

  // VarsayÄ±lan gÃ¶rÃ¼nÃ¼m
  return (
`ğŸ‘¤ *Profil Bilgileri*

${baseBody}`
  );
}
/* ==================== Mesaj Ä°ÅŸleyici ==================== */
async function handleMessageSafe(msg) {
  if (!shouldProcess(msg)) return;

  try {
    const s = await resolveSender(msg);
    const isAdmin = isAdminCheck(s);
    const contact = await msg.getContact().catch(() => null);
    const name = contact?.pushname || contact?.name || msg._data?.notifyName || (s.phoneId || s.lid || "unknown");

    const keyId = s.phoneId || s.lid || (msg.author || msg.from);
    const player = getPlayer(keyId, name);

    // Yeni alanlarÄ± garantiye al
    if (typeof player.crystals !== "number") player.crystals = 0;
    ensureCosmetics(player);

    if (player.stack <= 0) {
      player.stack = AUTO_TOPUP;
      await saveDB();
      try { await msg.reply(`ğŸ†“ Otomatik destek: +${AUTO_TOPUP} Ã§ip yÃ¼klendi. Bol ÅŸans!`); } catch {}
    }

    const keyGame = makeGameKey(msg, s);

    const body = (msg.body || "").trim();
    const args = body.split(/\s+/);
    const base = args[0]?.toLowerCase();

    if (body.toLowerCase() === "ping") { await msg.reply("pong"); return; }
    if (base === ".me") {
      return msg.reply(
        `name: ${player.name || "-"}\n` +
        `joined: ${player.joined}\n` +
        `keyId(DB): ${keyId}\nkeyGame(GAME): ${keyGame}\n` +
        `phoneId: ${s.phoneId || "-"} / last10: ${s.phoneIdLast10 || "-"}\n` +
        `lid: ${s.lid || "-"}\n` +
        `isAdmin: ${isAdmin}`
      );
    }
    if (base === ".state") {
      const g = games[keyGame];
      return msg.reply(g ? `Game var: bet=${g.bet} | P=[${g.playerHand?.length||0}] D=[${g.dealerHand?.length||0}]` : "Game yok.");
    }

    if (base === ".owo") {
      return msg.reply(OWO_HELP);
    }

    /* ==================== EVENT BUFF ==================== */
    if (base === ".eventbuff" || base === ".etkinlik") {
      if (!isAdmin) return msg.reply("ğŸš« Bu komut iÃ§in yetkin yok.");
      const sub = (args[1] || "").toLowerCase();

      if (sub === "off" || sub === "kapat" || sub === "bitir" || sub === "stop") {
        eventBuff.active = false;
        eventBuff.until = 0;
        return msg.reply("âš¡ Etkinlik buff'Ä± manuel olarak kapatÄ±ldÄ±.");
      }

      if (isEventBuffActive()) {
        return msg.reply(
`âš¡ Zaten bir etkinlik buff'Ä± aÃ§Ä±k.
Kalan sÃ¼re: ${eventBuffRemainingText()}
Kapatmak iÃ§in: .eventbuff off`
        );
      }

      const DURATION_MIN = 15;
      eventBuff.active = true;
      eventBuff.until = Date.now() + DURATION_MIN * 60 * 1000;

      return msg.reply(
`âš¡ *Etkinlik BaÅŸladÄ±!*

Ã–nÃ¼mÃ¼zdeki ${DURATION_MIN} dakika boyunca:
â€¢ .hunt kazanÃ§larÄ± arttÄ±
â€¢ .kutu Ã¶dÃ¼lleri buff aldÄ±
â€¢ Kutulardan *kristal* dÃ¼ÅŸme ihtimali yÃ¼kseldi ğŸ’

Mevcut durum: ${eventBuffRemainingText()}
Kapatmak iÃ§in: .eventbuff off`
      );
    }

    /* ==================== PET SÄ°STEMÄ° ==================== */
    if (base === ".pet") {
      if (!(await requireJoined(msg, player))) return;
      ensurePet(player);
      if (typeof player.crystals !== "number") player.crystals = 0;

      const sub = (args[1] || "").toLowerCase();

      if (sub === "shop" || sub === "market" || sub === "magaza" || sub === "maÄŸaza") {
        const buyableList = Object.values(PET_SHOP)
          .filter(p => p.buyable)
          .sort((a, b) => a.price - b.price)
          .map(p => {
            const cPrice = PET_CRYSTAL_PRICES[p.key] ?? null;
            const crystalLine = cPrice ? `   ğŸ’ Kristal Fiyat: ${cPrice}\n` : "";
            return (
`${p.emoji} *${p.label}*
   ğŸ’° Ã‡ip Fiyat: ${p.price} Ã§ip
${crystalLine}   ATK: ${p.atk} | LUCK: ${p.luck}
   ${p.desc}`
            );
          })
          .join("\n\n");

        const specialList = ["kaplumbaga","salyangoz","koala"]
          .map(k => PET_SHOP[k])
          .filter(Boolean)
          .map(p => {
            const cPrice = PET_CRYSTAL_PRICES[p.key] ?? null;
            const crystalLine = cPrice ? `   ğŸ’ Kristal Fiyat: ${cPrice}\n` : "";
            return (
`${p.emoji} *${p.label}* (Ã–zel)
${crystalLine}   ATK: ${p.atk} | LUCK: ${p.luck}
   ${p.desc}`
            );
          })
          .join("\n\n");

        let adminLine = "";
        if (isAdmin) {
          adminLine =
`\n\nğŸ‘‘ *Adminâ€™e Ã–zel Pet*:
${ADMIN_PET.emoji} *${ADMIN_PET.label}*
   ATK: ${ADMIN_PET.atk} | LUCK: ${ADMIN_PET.luck}
   Sadece: .pet adminkurt komutuyla alÄ±nabilir.`;
        }

        return msg.reply(
`ğŸ¾ *PET SHOP* ğŸ¾

ğŸ’  *SatÄ±n AlÄ±nabilen Petler (Ã‡ip & Kristal)*

${buyableList}

ğŸ’  *Ã–zel Petler (Kristal ile alÄ±nabilir)*

${specialList || "â€”"}

ğŸ’ *Kristal ile pet almak iÃ§in:*
â€¢ .pet al kedi kristal
â€¢ .pet al koala kristal

ğŸ“Œ Ã‡ip ile almak iÃ§in:
.pet al <tÃ¼r>
Ã–rn:
â€¢ .pet al kedi
â€¢ .pet al panda${adminLine}`
        );
      }

      if (!sub) {
        const power = getPetPower(player);
        if (!power.active) {
          const shopLines = Object.values(PET_SHOP)
            .filter(p => p.buyable)
            .sort((a, b) => a.price - b.price)
            .map(p => {
              const cPrice = PET_CRYSTAL_PRICES[p.key] ?? null;
              const crystalLine = cPrice ? ` | ğŸ’ ${cPrice} kristal` : "";
              return `${p.emoji} *${p.label}* â€” ${p.price} Ã§ip${crystalLine}\n   ATK: ${p.atk} | LUCK: ${p.luck}`;
            }).join("\n\n");

          return msg.reply(
`ğŸ¾ *Pet Sistemi*

Åu an bir petin yok.

Pet alarak:
â€¢ .hunt kazancÄ±na (ATK) bonus alÄ±rsÄ±n
â€¢ Kutularda ve hunt kutu dÃ¼ÅŸme ÅŸansÄ±nda (LUCK) bonus alÄ±rsÄ±n

ğŸ“¦ *Pet Shop*:
${shopLines}

Ã–zel petler (sadece kristal):
â€¢ ğŸ¢ KaplumbaÄŸa
â€¢ ğŸŒ Salyangoz
â€¢ ğŸ¨ Koala

ğŸ’ Kristal ile almak iÃ§in:
.pet al <tÃ¼r> kristal
Ã–rn:
â€¢ .pet al koala kristal`
          );
        } else {
          const { active, others, atk, luck } = power;
          const def = PET_SHOP[active.type];
          const emoji = def?.emoji || (active.type === ADMIN_PET.key ? ADMIN_PET.emoji : "ğŸ¾");
          const nameLine = getPetDisplayName(active);

          let specialInfo = "";
          if (active.type === "salyangoz") {
            specialInfo =
`\n\nâ­ *Ã–zel Ã–zellik (Salyangoz)*:
â€¢ Hunt'ta kutu/drop ÅŸansÄ±nÄ± arttÄ±rÄ±r.`;
          } else if (active.type === "koala") {
            specialInfo =
`\n\nâ­ *Ã–zel Ã–zellik (Koala)*:
â€¢ Bot aÃ§Ä±k olduÄŸu sÃ¼rece her 30 dakikada bir sana +3000 Ã§ip pasif gelir kazandÄ±rÄ±r.`;
          } else if (active.type === "kaplumbaga") {
            specialInfo =
`\n\nâ­ *Ã–zel Ã–zellik (KaplumbaÄŸa)*:
â€¢ Koleksiyon peti, sadece vitrin ve pasif gÃ¼Ã§ iÃ§in.`;
          } else if (active.type === ADMIN_PET.key) {
            specialInfo =
`\n\nâ­ *Ã–zel Ã–zellik (Alfa Kurt)*:
â€¢ Admin'e Ã¶zel efsane pet.`;
          }

          const othersLine = others.length
            ? `\nDiÄŸer petlerin (pasif %15): ${others.map(p => getPetDisplayName(p)).join(", ")}`
            : "";

          return msg.reply(
`${emoji} *Pet Bilgilerin*

Aktif Pet: ${nameLine}
TÃ¼r: ${active.type || "-"}
Seviye: ${active.level || 1}
XP: ${active.xp || 0}
Aktif ATK: ${active.atk || 0}
Aktif LUCK: ${active.luck || 0}

Toplam (aktif + pasif %15) gÃ¼Ã§:
ATK: ~${Math.round(atk)}
LUCK: ~${Math.round(luck)}${othersLine}${specialInfo}

Ä°sim deÄŸiÅŸtirmek iÃ§in:
.pet isim <yeni_isim>

ğŸ’ Toplam kristalin: ${player.crystals}`
          );
        }
      }

      if (sub === "liste") {
        ensurePet(player);
        const pets = player.pets || [];
        if (!pets.length) {
          return msg.reply("ğŸ¾ HenÃ¼z hiÃ§ petin yok. `.pet al <tÃ¼r>` ile alabilirsin.");
        }
        const lines = pets.map((p, i) => {
          const def = PET_SHOP[p.type];
          const emoji = def?.emoji || "ğŸ¾";
          const activeMark = (i === player.activePetIndex) ? " (aktif)" : "";
          const cPrice = PET_CRYSTAL_PRICES[p.type] ?? null;
          const crystalInfo = cPrice ? ` | (Kristal deÄŸeri: ~${cPrice})` : "";
          return `${i+1}. ${emoji} ${getPetDisplayName(p)} â€” ATK: ${p.atk || 0}, LUCK: ${p.luck || 0}${activeMark}${crystalInfo}`;
        }).join("\n");
        return msg.reply(
`ğŸ¾ *Petlerin*

${lines}

Aktif peti deÄŸiÅŸtirmek iÃ§in:
.pet set <numara>`);
      }

      if (sub === "set" || sub === "sec" || sub === "seÃ§") {
        const idxStr = args[2];
        if (!idxStr) return msg.reply("KullanÄ±m: `.pet set <numara>`\nListe iÃ§in: `.pet liste`");
        const idx = parseInt(idxStr, 10);
        ensurePet(player);
        const pets = player.pets || [];
        if (!Number.isFinite(idx) || idx < 1 || idx > pets.length) {
          return msg.reply("âš ï¸ GeÃ§erli bir pet numarasÄ± gir.\nListe iÃ§in: `.pet liste`");
        }
        player.activePetIndex = idx - 1;
        player.pet = pets[player.activePetIndex];
        await saveDB();
        return msg.reply(`ğŸ¾ Aktif petin artÄ±k: ${getPetDisplayName(player.pet)}`);
      }

      if (sub === "adminkurt" || sub === "adminpet" || sub === "admin") {
        if (!isAdmin) {
          return msg.reply("ğŸš« Bu pet sadece yÃ¶neticiler iÃ§indir.");
        }
        ensurePet(player);
        const pet = grantPet(player, ADMIN_PET.key);
        if (pet) {
          player.pet = pet;
        } else {
          const idx = player.pets.findIndex(p => p.type === ADMIN_PET.key);
          if (idx !== -1) {
            player.activePetIndex = idx;
            player.pet = player.pets[idx];
          }
        }
        if (player.pet) {
          player.pet.atk = ADMIN_PET.atk;
          player.pet.luck = ADMIN_PET.luck;
        }
        await saveDB();
        await checkAndUnlockTitles(msg, player);

        return msg.reply(
`${ADMIN_PET.emoji} *Admin Peti Verildi!*


ArtÄ±k *${ADMIN_PET.label}* senin yanÄ±nda:
ATK: ${ADMIN_PET.atk}
LUCK: ${ADMIN_PET.luck}

Bu peti sadece adminler alabilir.
ğŸ¦ Bakiye deÄŸiÅŸmedi: ${player.stack}`
        );
      }

      if (sub === "al" || sub === "buy") {
        const rawType = args[2];
        const method = normalizeTR(args[3] || "");
        if (!rawType) {
          return msg.reply(
`KullanÄ±m: .pet al <tÃ¼r> [kristal]

Ã–rnek tÃ¼rler:
â€¢ cekirge
â€¢ karinca
â€¢ panda
â€¢ keci
â€¢ at
â€¢ zebra
â€¢ kedi
â€¢ tavsan
â€¢ kopek
â€¢ kartal
â€¢ suaygiri
â€¢ fil
â€¢ tilki
â€¢ gergedan
â€¢ cita
â€¢ aslan
â€¢ ejderha

Ã–zel petler (sadece kristal ile mantÄ±klÄ±):
â€¢ kaplumbaga
â€¢ salyangoz
â€¢ koala

Ã–rnek:
â€¢ .pet al kedi
â€¢ .pet al koala kristal`
          );
        }

        const typeKey = petTypeFromInput(rawType) || normalizeTR(rawType);
        const cfg = PET_SHOP[typeKey];

        if (!cfg && !["kaplumbaga","salyangoz","koala"].includes(typeKey)) {
          return msg.reply("âš ï¸ GeÃ§ersiz pet tÃ¼rÃ¼.");
        }

        const payWithCrystal = method === "kristal" || method === "k" || method === "crystal";
        const crystalPrice = PET_CRYSTAL_PRICES[typeKey];

        if (payWithCrystal) {
          if (crystalPrice == null) {
            return msg.reply("âš ï¸ Bu pet kristal ile satÄ±n alÄ±namaz.");
          }
          if (player.crystals < crystalPrice) {
            return msg.reply(`ğŸš« Yetersiz kristal. Gerekli: ${crystalPrice}, Senin: ${player.crystals}`);
          }
        } else {
          if (!cfg || cfg.buyable === false) {
            return msg.reply("âš ï¸ Bu pet Ã§ip ile satÄ±n alÄ±namaz, kristal ile dene: `.pet al <tÃ¼r> kristal`");
          }
          if (player.stack < cfg.price) {
            return msg.reply(`ğŸš« Yetersiz bakiye. Gerekli: ${cfg.price}, Senin: ${player.stack}`);
          }
        }

        ensurePet(player);

        if (payWithCrystal) {
          player.crystals -= crystalPrice;
        } else {
          player.stack -= cfg.price;
        }

        const def = cfg || PET_SHOP[typeKey];
        if (!def) {
          return msg.reply("âš ï¸ Ä°Ã§sel pet tanÄ±mÄ± bulunamadÄ±.");
        }

        const pet = {
          type: def.key,
          name: def.label,
          level: 1,
          xp: 0,
          atk: def.atk,
          luck: def.luck
        };

        if (hasPetType(player, def.key)) {
          // Zaten varsa sadece aktif yap
          const idx = player.pets.findIndex(p => p.type === def.key);
          if (idx !== -1) player.activePetIndex = idx;
        } else {
          player.pets.push(pet);
          if (player.activePetIndex === -1) player.activePetIndex = player.pets.length - 1;
        }
        player.pet = player.pets[player.activePetIndex];

        await saveDB();
        await checkAndUnlockTitles(msg, player);

        const payText = payWithCrystal
          ? `ğŸ’ Ã–denen kristal: ${crystalPrice}\nğŸ’ Kalan kristal: ${player.crystals}`
          : `ğŸ¦ Kalan Bakiye: ${player.stack}`;

        return msg.reply(
`${def.emoji} *Pet SatÄ±n AlÄ±ndÄ±!* (TÃ¼r: ${def.label})

ATK: ${def.atk}
LUCK: ${def.luck}

Petin:
â€¢ .hunt kazancÄ±nÄ± artÄ±rÄ±r
â€¢ Kutulardaki Ã¶dÃ¼le bonus ekler

Ä°sim vermek iÃ§in:
.pet isim <yeni_isim>

${payText}`
        );
      }

      if (sub === "isim" || sub === "name") {
        ensurePet(player);
        if (!player.pet) {
          return msg.reply("Åu an bir petin yok. Ã–nce `.pet al <tÃ¼r>` veya admin isen `.pet adminkurt` ile pet al.");
        }
        const newName = args.slice(2).join(" ").trim();
        if (!newName) {
          return msg.reply("KullanÄ±m: `.pet isim <yeni_isim>`");
        }
        if (newName.length > 24) {
          return msg.reply("âš ï¸ Ä°sim Ã§ok uzun. Maksimum 24 karakter kullan.");
        }
        player.pet.name = newName;
        await saveDB();
        return msg.reply(`ğŸ¾ Petinin yeni adÄ±: *${newName}*`);
      }

      return msg.reply(
`ğŸ¾ Pet komutlarÄ±:
â€¢ .pet â€” Pet durumunu gÃ¶ster
â€¢ .pet al <tÃ¼r> [kristal] â€” Pet satÄ±n al
â€¢ .pet liste â€” TÃ¼m petlerini listele
â€¢ .pet set <numara> â€” Aktif pet seÃ§
â€¢ .pet shop â€” TÃ¼m petleri ve kristal/Ã§ip fiyatlarÄ±nÄ± gÃ¶r
â€¢ .pet adminkurt â€” (Sadece admin) Ã¶zel Alfa Kurt peti
â€¢ .pet isim <yeni_isim> â€” Petine isim ver`);
    }

    if (base === ".pets") {
      if (!(await requireJoined(msg, player))) return;
      ensurePet(player);
      const pets = player.pets || [];
      if (!pets.length) {
        return msg.reply("ğŸ¾ HenÃ¼z hiÃ§ petin yok. `.pet al <tÃ¼r>` ile pet satÄ±n alabilirsin.");
      }

      const lines = pets.map((p, i) => {
        const def = PET_SHOP[p.type];
        const emoji = def?.emoji || (p.type === ADMIN_PET.key ? ADMIN_PET.emoji : "ğŸ¾");
        const activeMark = (i === player.activePetIndex) ? " â­ (Aktif)" : "";
        const name = getPetDisplayName(p);
        const level = p.level || 1;
        const atk = p.atk || 0;
        const luck = p.luck || 0;
        const xp = p.xp || 0;
        const cPrice = PET_CRYSTAL_PRICES[p.type] ?? null;
        const crystalInfo = cPrice ? `\n   â€¢ Tahmini kristal deÄŸeri: ~${cPrice}` : "";
        return `${i + 1}. ${emoji} *${name}*${activeMark}
   â€¢ TÃ¼r: ${p.type || "-"}
   â€¢ Seviye: ${level}
   â€¢ XP: ${xp}
   â€¢ ATK: ${atk}
   â€¢ LUCK: ${luck}${crystalInfo}`;
      }).join("\n\n");

      return msg.reply(
`ğŸ¾ *Pet Koleksiyonun* ğŸ¾

${lines}

ğŸ”¹ Aktif peti deÄŸiÅŸtirmek iÃ§in:
.pet set <numara>

ğŸ”¹ Detay gÃ¶rmek iÃ§in:
.pet`);
    }

    /* Grup admin araÃ§larÄ± (everyone / kilit) aynÄ± kalÄ±yor */
    if (base === "!everyone" || base === "!kilit" || base === "!kilitaÃ§" || base === "!kilitac") {
      const { isGroup, isGroupAdmin, chat } = await isGroupAdminByMsg(msg);
      if (!isGroup) return msg.reply("â„¹ï¸ Bu komut sadece *gruplarda* kullanÄ±labilir.");

      const canModerate = isAdmin || isGroupAdmin;
      if ((base === "!kilit" || base === "!kilitaÃ§" || base === "!kilitac") && !canModerate) {
        return msg.reply("ğŸš« Bu komut iÃ§in grup yÃ¶neticisi olmalÄ±sÄ±n (ya da bot admini).");
      }

      if (base === "!everyone") {
        try {
          const participants = chat.participants || [];
          if (!participants.length) return msg.reply("âš ï¸ Grup katÄ±lÄ±mcÄ±larÄ± alÄ±namadÄ±.");
          const mentionContacts = await Promise.all(
            participants.map(p => client.getContactById(p.id._serialized))
          );
          const tagLine = participants.map(p => `@${p.id.user}`).join(" ");
          const extra = args.slice(1).join(" ").trim();
          const text = (extra ? `${extra}\n` : "") + tagLine;
          await chat.sendMessage(text, { mentions: mentionContacts });
        } catch (e) {
          console.error("!everyone hatasÄ±:", e);
          await msg.reply("âš ï¸ everyone gÃ¶nderilemedi.");
        }
        return;
      }

      if (base === "!kilit") {
        try {
          await chat.setMessagesAdminsOnly(true);
          await msg.reply("ğŸ”’ Grup *sadece yÃ¶neticilere* kilitlendi.");
        } catch (e) {
          console.error("!kilit hatasÄ±:", e);
          await msg.reply("âš ï¸ Kilitlenemedi. Botun *grup yÃ¶neticisi* olmasÄ± gerekebilir.");
        }
        return;
      }

      if (base === "!kilitaÃ§" || base === "!kilitac") {
        try {
          await chat.setMessagesAdminsOnly(false);
          await msg.reply("ğŸ”“ Grup yeniden *herkese* aÃ§Ä±ldÄ±.");
        } catch (e) {
          console.error("!kilitaÃ§ hatasÄ±:", e);
          await msg.reply("âš ï¸ Kilit aÃ§Ä±lamadÄ±. Botun *grup yÃ¶neticisi* olmasÄ± gerekebilir.");
        }
        return;
      }
    }

    if (base === ".join") {
      if (player.joined) {
        const activeTitleName = getActiveTitleName(player);
        const titleLine = activeTitleName ? `\nğŸ– Unvan: ${activeTitleName}` : "";
        return msg.reply(`âœ… Zaten katÄ±ldÄ±n.\nğŸ¦ Bakiye: ${player.stack}${titleLine}`);
      }
      player.joined = true;
      await saveDB();
      await checkAndUnlockTitles(msg, player);
      return msg.reply(
`ğŸŸ *Oyuna katÄ±ldÄ±n!*
HoÅŸ geldin ${player.name || ""} ğŸ‰
ğŸ¦ BaÅŸlangÄ±Ã§ bakiyen: ${player.stack}
Skor tablosunda gÃ¶rÃ¼nÃ¼rsÃ¼n. Bol ÅŸans!`
      );
    }

    if (
      base === ".yardÄ±m" || base === ".yardim" ||
      (base === ".bj" && ["yardÄ±m","yardim","help","menu","menÃ¼"].includes((args[1]||"").toLowerCase()))
    ) {
      return msg.reply(buildHelpText(isAdmin));
    }

    /* ========== PROFÄ°L (tema + kristal entegre) ========== */
    if (base === ".profil" || base === ".profile") {
      return msg.reply(renderProfile(player, isAdmin));
    }

    /* ========== DETAYLI / GLOBAL Ä°STATÄ°STÄ°K ========== */
    if (
      base === ".istatistik" ||
      base === ".istatistikler" ||
      base === ".istatistic" ||
      base === ".stats"
    ) {
      const sub = (args[1] || "").toLowerCase();

      if (base === ".stats" && (sub === "all" || sub === "genel" || sub === "global")) {
        const allPlayers = Object.values(db.data.players || {});
        let totalPlayers = allPlayers.length;
        let joinedPlayers = 0;
        let totalStack = 0;

        let totalSlotGames = 0;
        let totalSlotNetWin = 0;
        let totalRouletteGames = 0;
        let totalRouletteWins = 0;
        let totalRouletteLosses = 0;
        let totalBjGames = 0;
        let totalBjWins = 0;
        let totalBjLosses = 0;
        let totalHuntCount = 0;
        let totalHuntProfit = 0;
        let totalBoxesOpened = 0;
        let totalBoxesInventory = 0;
        let totalDailyDays = 0;
        let totalCrystals = 0;

        for (const p of allPlayers) {
          ensureStats(p);
          ensureInventory(p);
          if (typeof p.crystals !== "number") p.crystals = 0;

          totalStack += p.stack || 0;
          totalCrystals += p.crystals || 0;
          if (p.joined) joinedPlayers++;

          const s2 = p.stats || {};
          totalSlotGames      += s2.slotGames       || 0;
          totalSlotNetWin     += s2.slotNetWin      || 0;
          totalRouletteGames  += s2.rouletteGames   || 0;
          totalRouletteWins   += s2.rouletteWins    || 0;
          totalRouletteLosses += s2.rouletteLosses  || 0;
          totalBjGames        += s2.bjGames         || 0;
          totalBjWins         += s2.bjWins          || 0;
          totalBjLosses       += s2.bjLosses        || 0;
          totalHuntCount      += s2.huntCount       || 0;
          totalHuntProfit     += s2.huntProfit      || 0;
          totalBoxesOpened    += s2.boxesOpened     || 0;
          totalDailyDays      += s2.dailyDays       || 0;
          totalBoxesInventory += (p.inv && p.inv.boxes) || 0;
        }

        const avgStack = totalPlayers ? Math.round(totalStack / totalPlayers) : 0;

        return msg.reply(
`ğŸ“Š *GLOBAL OYUN Ä°STATÄ°STÄ°KLERÄ°* ğŸ“Š

ğŸ‘¥ Toplam kayÄ±tlÄ± oyuncu: ${totalPlayers}
ğŸŸ¢ Oyuna katÄ±lmÄ±ÅŸ oyuncu: ${joinedPlayers}
ğŸ’° Toplam bakiye: ${totalStack}
ğŸ’³ Oyuncu baÅŸÄ± ortalama bakiye: ${avgStack}
ğŸ’ Toplam kristal: ${totalCrystals}

ğŸ° *Slot*
â€¢ Toplam oyun: ${totalSlotGames}
â€¢ Toplam net kazanÃ§: ${totalSlotNetWin}

ğŸ¡ *Rulet*
â€¢ Toplam oyun: ${totalRouletteGames}
â€¢ Kazanma: ${totalRouletteWins}
â€¢ Kaybetme: ${totalRouletteLosses}

ğŸƒ *Blackjack*
â€¢ Toplam el: ${totalBjGames}
â€¢ Kazanma: ${totalBjWins}
â€¢ Kaybetme: ${totalBjLosses}

ğŸ¹ *Hunt*
â€¢ Toplam hunt: ${totalHuntCount}
â€¢ Toplam kazanÃ§: ${totalHuntProfit}

ğŸ *Kutu*
â€¢ Toplam aÃ§Ä±lan kutu: ${totalBoxesOpened}
â€¢ Envanterdeki kutular: ${totalBoxesInventory}

ğŸ“… *GÃ¼nlÃ¼k*
â€¢ Toplam alÄ±nan gÃ¼nlÃ¼k Ã¶dÃ¼l: ${totalDailyDays}`
        );
      }

      if (!(await requireJoined(msg, player))) return;

      ensureStats(player);
      ensureInventory(player);
      ensurePet(player);
      ensureTitles(player);

      const s = player.stats || {};
      const { level, totalXp } = calculatePlayerLevel(player);

      const rouletteWinRate = s.rouletteGames
        ? Math.round((s.rouletteWins / s.rouletteGames) * 100)
        : 0;

      const bjWinRate = s.bjGames
        ? Math.round((s.bjWins / s.bjGames) * 100)
        : 0;

      const avgHuntProfit = s.huntCount
        ? Math.round(s.huntProfit / s.huntCount)
        : 0;

      const titlesCount = (player.titles?.owned?.length) || 0;
      const petsCount = (player.pets?.length) || 0;
      const boxesOwned = player.inv?.boxes || 0;

      return msg.reply(
`ğŸ“Š *DetaylÄ± Ä°statistikler*

ğŸ‘¤ Oyuncu: ${player.name || "-"}
ğŸ¦ Bakiye: ${player.stack}
ğŸ’ Kristal: ${player.crystals}
â­ Seviye: ${level} (XP: ${totalXp})

ğŸ° *Slot*
â€¢ Oynanan oyun: ${s.slotGames}
â€¢ Net kazanÃ§: ${s.slotNetWin}

ğŸ¡ *Rulet*
â€¢ Oynanan oyun: ${s.rouletteGames}
â€¢ Kazanma: ${s.rouletteWins}
â€¢ Kaybetme: ${s.rouletteLosses}
â€¢ Kazanma oranÄ±: ${rouletteWinRate}%

ğŸƒ *Blackjack*
â€¢ Oynanan el: ${s.bjGames}
â€¢ Kazanma: ${s.bjWins}
â€¢ Kaybetme: ${s.bjLosses}
â€¢ Kazanma oranÄ±: ${bjWinRate}%

ğŸ¹ *Hunt*
â€¢ Hunt sayÄ±sÄ±: ${s.huntCount}
â€¢ Toplam kazanÃ§: ${s.huntProfit}
â€¢ Ortalama kazanÃ§: ${avgHuntProfit}

ğŸ *Kutu*
â€¢ AÃ§Ä±lan kutu: ${s.boxesOpened}
â€¢ Envanterdeki kutu: ${boxesOwned}

ğŸ“… *GÃ¼nlÃ¼k*
â€¢ GÃ¼nlÃ¼k Ã¶dÃ¼l aldÄ±ÄŸÄ±n gÃ¼n sayÄ±sÄ±: ${s.dailyDays}

ğŸ– Unvan sayÄ±sÄ±: ${titlesCount}
ğŸ¾ Pet sayÄ±sÄ±: ${petsCount}

â„¹ï¸ Ã–zet gÃ¶rÃ¼nÃ¼m iÃ§in: .profil`
      );
    }

    /* Buradan sonrasÄ±: .seviye, .bakiye, .score, .top seviye,
       .gÃ¶rev, .unvan, admin para komutlarÄ±, .bj / .rulet / .slot / .kutu / .hunt / .gÃ¼nlÃ¼k
       ve yeni .kristal / .profilskin devam ediyor */
    // (DEVAMI BÃ–LÃœM 7 / 8'DE)
  } catch (err) {
    console.error("Mesaj iÅŸleme hatasÄ±:", err);
    try { await msg.reply("âš ï¸ Ä°Ã§ hata oluÅŸtu, lÃ¼tfen tekrar deneyin."); } catch {}
  }
}
/* ==================== Kristal â†” Ã‡ip AyarlarÄ± ==================== */
// 1 kristal kaÃ§ Ã§ip eder?
// Ä°stersen burayÄ± deÄŸiÅŸtirebilirsin.
const CRYSTAL_TO_CHIP = 50000; // 1 kristal = 50.000 Ã§ip

/* ==================== Ek Mesaj Dinleyici (Sadece .kristal / .profilskin) ==================== */
/*
  handleMessageSafe'e dokunmadan yeni komut eklemek iÃ§in
  ayrÄ± bir dinleyici kullanÄ±yoruz. Sadece:
  - .kristal
  - .profilskin
  mesajlarÄ±nda Ã§alÄ±ÅŸÄ±r, diÄŸerlerine hiÃ§ dokunmaz.
*/
client.on("message", async (msg) => {
  try {
    if (!shouldProcess(msg)) return;

    const bodyRaw = (msg.body || "").trim();
    if (!bodyRaw.startsWith(".")) return; // komut deÄŸilse boÅŸver

    const parts = bodyRaw.split(/\s+/);
    const base = parts[0].toLowerCase();

    // Sadece bu iki komutta Ã§alÄ±ÅŸsÄ±n
    if (base !== ".kristal" && base !== ".profilskin") return;

    const sender = await resolveSender(msg);
    const isAdmin = isAdminCheck(sender);
    const contact = await msg.getContact().catch(() => null);
    const name =
      contact?.pushname ||
      contact?.name ||
      msg._data?.notifyName ||
      sender.phoneId ||
      sender.lid ||
      "unknown";

    const keyId = sender.phoneId || sender.lid || (msg.author || msg.from);
    const player = getPlayer(keyId, name);

    if (typeof player.crystals !== "number") player.crystals = 0;
    ensureCosmetics(player);

    /* ========== .KRÄ°STAL KOMUTU ========== */
    if (base === ".kristal") {
      const sub = (parts[1] || "").toLowerCase();

      // Sadece bakiyeyi gÃ¶rmek
      if (!sub) {
        return msg.reply(
`ğŸ’ *Kristal Durumu*

Oyuncu: ${player.name || "-"}

ğŸ’ Kristal: ${player.crystals}
ğŸ’° 1 kristal â‰ˆ ${CRYSTAL_TO_CHIP.toLocaleString("tr-TR")} Ã§ip

Kristali Ã§ipe Ã§evirmek iÃ§in:
â€¢ .kristal bozdur <miktar>
  Ã–rnek: .kristal bozdur 3
â€¢ TÃ¼mÃ¼nÃ¼ bozdurmak iÃ§in: .kristal bozdur max`
        );
      }

      if (sub === "bozdur" || sub === "boz" || sub === "convert") {
        const rawAmount = (parts[2] || "").toLowerCase();

        if (!rawAmount) {
          return msg.reply(
`KullanÄ±m:
â€¢ .kristal bozdur <miktar>
Ã–rnek:
â€¢ .kristal bozdur 3
â€¢ .kristal bozdur max`
          );
        }

        let amount;
        if (rawAmount === "max" || rawAmount === "hepsi" || rawAmount === "all") {
          amount = player.crystals;
        } else {
          amount = parseInt(rawAmount, 10);
        }

        if (!Number.isFinite(amount) || amount <= 0) {
          return msg.reply("âš ï¸ GeÃ§erli bir kristal miktarÄ± gir.");
        }
        if (player.crystals < amount) {
          return msg.reply(
`ğŸš« Yetersiz kristal.
Elindeki: ${player.crystals}
Ä°stediÄŸin: ${amount}`
          );
        }

        const chipGain = amount * CRYSTAL_TO_CHIP;
        player.crystals -= amount;
        player.stack += chipGain;
        await saveDB();

        return msg.reply(
`âœ… *Kristal Bozduruldu!*

Bozdurulan kristal: ${amount}
ğŸ’° KazanÄ±lan Ã§ip: ${chipGain.toLocaleString("tr-TR")}

ğŸ”¹ GÃ¼ncel durum:
ğŸ’ Kristal: ${player.crystals}
ğŸ¦ Bakiye: ${player.stack.toLocaleString("tr-TR")}`
        );
      }

      return msg.reply(
`ğŸ’ *Kristal KomutlarÄ±*

â€¢ .kristal
   â†’ Mevcut kristal bakiyeni ve oranÄ± gÃ¶sterir.

â€¢ .kristal bozdur <miktar>
   â†’ Kristali Ã§ipe Ã§evirir.
   Ã–rnek: .kristal bozdur 2

â€¢ .kristal bozdur max
   â†’ TÃ¼m kristallerini Ã§ipe Ã§evirir.`
      );
    }

    /* ========== .PROFÄ°LSKÄ°N KOMUTU (Profil TemalarÄ±) ========== */
    if (base === ".profilskin" || base === ".profiltema" || base === ".tema") {
      const sub = (parts[1] || "").toLowerCase();
      const cosmetics = player.cosmetics || {};
      const ownedSkins = cosmetics.ownedSkins || [];
      const activeSkin = cosmetics.activeSkin || "default";

      // YardÄ±m fonksiyonu: shop listesini yazdÄ±rmak
      const buildSkinShopText = () => {
        if (!PROFILE_SKINS || typeof PROFILE_SKINS !== "object") {
          return "âš ï¸ Tema sistemi ÅŸu an tanÄ±mlÄ± deÄŸil.";
        }

        const lines = Object.values(PROFILE_SKINS).map((skin) => {
          const key = skin.key || skin.id || "unknown";
          const nameLabel = skin.label || skin.name || key;
          const rarity = skin.rarity || "Normal";
          const price = skin.priceCrystal ?? skin.crystalPrice ?? 0;
          const adminOnly = !!skin.adminOnly;

          const has = ownedSkins.includes(key);
          const isActive = activeSkin === key;
          const ownedTag = has ? (isActive ? " (SENÄ°N â€“ AKTÄ°F)" : " (SENÄ°N)") : "";
          const priceLine = price > 0 ? `ğŸ’ ${price} kristal` : "âœ… Ãœcretsiz";
          const adminLine = adminOnly ? " | ğŸ‘‘ Sadece admin" : "";

          return `ğŸ”¹ *${nameLabel}* [${rarity}]${ownedTag}
   Anahtar: ${key}
   Fiyat: ${priceLine}${adminLine}`;
        }).join("\n\n");

        return (
`ğŸ¨ *Profil Tema MaÄŸazasÄ±*

Mevcut kristalin: ${player.crystals}

${lines}

Tema almak iÃ§in:
â€¢ .profilskin al <anahtar>

Aktif temayÄ± deÄŸiÅŸtirmek iÃ§in:
â€¢ .profilskin set <anahtar>

Ã–rnek:
â€¢ .profilskin al nadir
â€¢ .profilskin set efsanevi`
        );
      };

      // HiÃ§ alt komut yoksa: shop + aktif tema gÃ¶ster
      if (!sub || sub === "liste" || sub === "shop" || sub === "magaza" || sub === "maÄŸaza") {
        const shopText = buildSkinShopText();
        return msg.reply(shopText);
      }

      // Tema satÄ±n alma
      if (sub === "al" || sub === "buy" || sub === "satÄ±nal" || sub === "satinal") {
        const keyInput = (parts[2] || "").toLowerCase();
        if (!keyInput) {
          return msg.reply(
`KullanÄ±m:
â€¢ .profilskin al <tema_anahtarÄ±>

Tema listesini gÃ¶rmek iÃ§in:
â€¢ .profilskin liste`
          );
        }

        if (!PROFILE_SKINS || typeof PROFILE_SKINS !== "object") {
          return msg.reply("âš ï¸ Tema sistemi ÅŸu an tanÄ±mlÄ± deÄŸil.");
        }

        const allSkins = Object.values(PROFILE_SKINS);
        const skin =
          allSkins.find(s => (s.key || s.id || "").toLowerCase() === keyInput) ||
          allSkins.find(s => (s.shortKey || "").toLowerCase() === keyInput) ||
          allSkins.find(s => (s.label || "").toLowerCase() === keyInput);

        if (!skin) {
          return msg.reply("âš ï¸ GeÃ§erli bir tema anahtarÄ± gir.\nListe iÃ§in: `.profilskin liste`");
        }

        const key = skin.key || skin.id;
        const nameLabel = skin.label || skin.name || key;
        const price = skin.priceCrystal ?? skin.crystalPrice ?? 0;
        const adminOnly = !!skin.adminOnly;

        if (ownedSkins.includes(key)) {
          return msg.reply(`âœ… *${nameLabel}* temasÄ±na zaten sahipsin.\nAktif yapmak iÃ§in: .profilskin set ${key}`);
        }

        if (adminOnly && !isAdmin) {
          return msg.reply("ğŸš« Bu tema sadece yÃ¶neticiler iÃ§indir.");
        }

        if (price > 0 && player.crystals < price) {
          return msg.reply(
`ğŸš« Yetersiz kristal.

Tema: ${nameLabel}
Gerekli: ${price}
Senin: ${player.crystals}

Daha fazla kristal iÃ§in:
â€¢ Kutu aÃ§
â€¢ Etkinliklerde kristal buff yakala
â€¢ Ã–zel gÃ¶revler (varsa)`
          );
        }

        if (price > 0) {
          player.crystals -= price;
        }

        // Tema satÄ±n alÄ±nÄ±yor
        if (!ownedSkins.includes(key)) {
          ownedSkins.push(key);
        }
        cosmetics.ownedSkins = ownedSkins;
        player.cosmetics = cosmetics;

        // Ä°lk defa tema alÄ±yorsa otomatik aktif yap
        if (!activeSkin || activeSkin === "default") {
          cosmetics.activeSkin = key;
        }

        await saveDB();

        return msg.reply(
`ğŸ¨ *Tema SatÄ±n AlÄ±ndÄ±!*

Tema: ${nameLabel}
Ã–denen kristal: ${price}
Kalan kristalin: ${player.crystals}

Aktif tema: ${cosmetics.activeSkin || key}

Profiline bakmak iÃ§in:
â€¢ .profil

Aktif temayÄ± deÄŸiÅŸtirmek iÃ§in:
â€¢ .profilskin set <anahtar>`
        );
      }

      // Tema set etme
      if (sub === "set" || sub === "sec" || sub === "seÃ§") {
        const keyInput = (parts[2] || "").toLowerCase();
        if (!keyInput) {
          return msg.reply(
`KullanÄ±m:
â€¢ .profilskin set <tema_anahtarÄ±>

Tema listesini gÃ¶rmek iÃ§in:
â€¢ .profilskin liste`
          );
        }

        if (!PROFILE_SKINS || typeof PROFILE_SKINS !== "object") {
          return msg.reply("âš ï¸ Tema sistemi ÅŸu an tanÄ±mlÄ± deÄŸil.");
        }

        const allSkins = Object.values(PROFILE_SKINS);
        const skin =
          allSkins.find(s => (s.key || s.id || "").toLowerCase() === keyInput) ||
          allSkins.find(s => (s.shortKey || "").toLowerCase() === keyInput) ||
          allSkins.find(s => (s.label || "").toLowerCase() === keyInput);

        if (!skin) {
          return msg.reply("âš ï¸ GeÃ§erli bir tema anahtarÄ± gir.\nListe iÃ§in: `.profilskin liste`");
        }

        const key = skin.key || skin.id;
        const nameLabel = skin.label || skin.name || key;
        const adminOnly = !!skin.adminOnly;

        if (!ownedSkins.includes(key)) {
          if (adminOnly && isAdmin) {
            // admin temasÄ±, admin isteyince direkt verebiliriz
            ownedSkins.push(key);
            cosmetics.ownedSkins = ownedSkins;
          } else {
            return msg.reply(
`Bu temaya henÃ¼z sahip deÄŸilsin.

SatÄ±n almak iÃ§in:
â€¢ .profilskin al ${key}

Tema detaylarÄ± iÃ§in:
â€¢ .profilskin liste`
            );
          }
        }

        if (adminOnly && !isAdmin) {
          return msg.reply("ğŸš« Bu tema sadece yÃ¶neticiler iÃ§in.");
        }

        cosmetics.activeSkin = key;
        player.cosmetics = cosmetics;
        await saveDB();

        return msg.reply(
`âœ… Aktif profil temasÄ± deÄŸiÅŸtirildi!

Yeni tema: *${nameLabel}*

Profiline bak:
â€¢ .profil`
        );
      }

      // YanlÄ±ÅŸ / bilinmeyen alt komut
      return msg.reply(
`ğŸ¨ *Profil Tema KomutlarÄ±*

â€¢ .profilskin liste
   â†’ TÃ¼m temalarÄ±, fiyatlarÄ±nÄ± ve sahiplik durumunu gÃ¶sterir.

â€¢ .profilskin al <anahtar>
   â†’ Kristal ile yeni bir tema satÄ±n al.

â€¢ .profilskin set <anahtar>
   â†’ Sahip olduÄŸun temalardan birini aktif yap.

Ã–rnekler:
â€¢ .profilskin liste
â€¢ .profilskin al nadir
â€¢ .profilskin set efsanevi`
      );
    }
  } catch (err) {
    console.error("Ek komutlarda hata (.kristal / .profilskin):", err);
    try { await msg.reply("âš ï¸ Tema/kristal komutunda iÃ§ hata oluÅŸtu, lÃ¼tfen tekrar dene."); } catch {}
  }
});
/* ===== OwO tarzÄ± Ã¶ÄŸretici metni (GÃœNCEL: kristal + profil temalarÄ±) ===== */
const OWO_HELP =
`ğŸ¾ *OwO TarzÄ± Oyun Sistemi Nedir?*

Bu bot, OwO tarzÄ± bir *ekonomi ve mini oyun* sistemidir.
AmaÃ§: Ã§ip ve *kristal* biriktirmek, oyunlar oynayÄ±p kazanmak,
gÃ¼nlÃ¼k gÃ¶revleri tamamlayÄ±p *unvanlar, petler ve profil temalarÄ±* toplamak. ğŸ’«

ğŸ® *Temel Komutlar*
â€¢ .join â€” Oyuna katÄ±l, baÅŸlangÄ±Ã§ Ã§ipini al
â€¢ .bakiye â€” Bakiyeni ve aktif unvanÄ±nÄ± gÃ¶r
â€¢ .profil â€” Profilini, istatistiklerini ve temasÄ±nÄ± gÃ¶r
â€¢ .stats â€” KiÅŸisel istatistiklerini gÃ¶sterir
â€¢ .stats all â€” TÃ¼m oyuncularÄ±n global istatistiklerini gÃ¶sterir
â€¢ .seviye â€” Seviyeni ve XP ilerlemeni gÃ¶r
â€¢ .top seviye â€” En yÃ¼ksek seviyedeki oyuncularÄ± gÃ¶r
â€¢ .gÃ¼nlÃ¼k â€” GÃ¼nlÃ¼k Ã§ip Ã¶dÃ¼lÃ¼nÃ¼ al
â€¢ .slot <miktar> â€” Slot makinesi oynarsÄ±n
â€¢ .rulet <miktar> <seÃ§im> â€” Rulet oynarsÄ±n (Ã¶rn: .rulet 100 kÄ±rmÄ±zÄ±)
â€¢ .bj <miktar> â€” Blackjack oyunu baÅŸlatÄ±r
â€¢ .hunt â€” Avlan, Ã§ip ve kutu bul (pet bonuslarÄ±yla daha da gÃ¼Ã§lÃ¼)
â€¢ .kutu â€” Elindeki kutularÄ± aÃ§
â€¢ .kutu all â€” TÃ¼m kutularÄ± tek seferde aÃ§
â€¢ .gÃ¶rev â€” BugÃ¼ne Ã¶zel rastgele 3 gÃ¶revi gÃ¶sterir
â€¢ .unvan â€” UnvanlarÄ±nÄ± listele / seÃ§
â€¢ .pet â€” Pet sistemini ve petini yÃ¶net
â€¢ .pet shop â€” Pet maÄŸazasÄ±nÄ± gÃ¶r
â€¢ .pets â€” TÃ¼m pet koleksiyonunu gÃ¶r
â€¢ .kristal â€” Kristal bakiyeni ve bozdurma oranÄ±nÄ± gÃ¶r
â€¢ .kristal bozdur <miktar|max> â€” Kristali Ã§ipe Ã§evir
â€¢ .profilskin liste â€” Profil temasÄ± maÄŸazasÄ±nÄ± gÃ¶ster
â€¢ .profilskin al <tema> â€” Kristalle yeni tema satÄ±n al
â€¢ .profilskin set <tema> â€” Sahip olduÄŸun temayÄ± aktif yap
â€¢ .owo â€” Bu rehberi tekrar gÃ¶sterir

ğŸ’° *Para Birimi ve Kristal Sistemi*
â€¢ Ana para: *Ã§ip*
â€¢ Nadir para: *kristal* ğŸ’
â€¢ Kristal genelde *kutu aÃ§arken* dÃ¼ÅŸÃ¼k ihtimalle dÃ¼ÅŸer.
â€¢ Etkinlik buffâ€™Ä± aÃ§Ä±kken, kristal dÃ¼ÅŸme ihtimali de artar.
â€¢ Kristalleri:
  - Yeni petler almak iÃ§in
  - Ã–zel / efsanevi petlere alternatif yol olarak
  - Profil temalarÄ± satÄ±n almak iÃ§in
  - Ä°stersen direkt Ã§ipe Ã§evirmek iÃ§in kullanabilirsin.

â€¢ .kristal â†’ Kristal bakiyeni ve oranÄ± gÃ¶sterir
â€¢ .kristal bozdur 3 â†’ 3 kristali Ã§ipe Ã§evirir
â€¢ .kristal bozdur max â†’ TÃ¼m kristallerini Ã§ipe Ã§evirir

ğŸ¨ *Profil Tema Sistemi*
Profil ekranÄ±n artÄ±k *tema destekli*:

â€¢ Temalar nadirliklere ayrÄ±lÄ±r:
  - Normal
  - Nadir
  - Efsanevi
  - ğŸ‘‘ Adminâ€™e Ã¶zel Ã¶zel tema

â€¢ Temalar kristal ile alÄ±nÄ±r:
  - .profilskin liste â†’ TÃ¼m temalarÄ± ve kristal fiyatlarÄ±nÄ± gÃ¶r
  - .profilskin al <tema_anahtarÄ±> â†’ Tema satÄ±n al
  - .profilskin set <tema_anahtarÄ±> â†’ Sahip olduÄŸun temayÄ± aktif yap
â€¢ Admin temasÄ± sadece yÃ¶neticiler tarafÄ±ndan kullanÄ±labilir.

ğŸ‘¤ *Profil EkranÄ±*
â€¢ .profil ile:
  - AdÄ±n, bakiye ve kristalin
  - Aktif unvanÄ±n
  - Aktif petin
  - Genel istatistiklerin (slot, rulet, bj, hunt, kutu, gÃ¼nlÃ¼k)
  - BugÃ¼nkÃ¼ gÃ¶revlerin
  - *Aktif profil temasÄ±* (tema sistemine uygun gÃ¶rÃ¼nÃ¼m) gÃ¶sterilir.

ğŸ¾ *Pet Sistemi (Ã‡oklu Pet)*
ArtÄ±k birden fazla pet alabilirsin.
Her petin;
â€¢ ATK (saldÄ±rÄ±) â†’ Hunt kazancÄ±nÄ± arttÄ±rÄ±r
â€¢ LUCK (ÅŸans) â†’ Kutu drop ve Ã¶dÃ¼l bonusunu arttÄ±rÄ±r

â€¢ Sadece *1 pet* aktif olur, gÃ¼cÃ¼nÃ¼n %100â€™Ã¼ gelir.
â€¢ DiÄŸer tÃ¼m sahip olduÄŸun petler toplam gÃ¼ce *%15* pasif katkÄ± saÄŸlar.
â€¢ Petler hunt & kutu aÃ§tÄ±kÃ§a XP kazanÄ±r (gelecekte seviye sistemi geniÅŸletilebilir).

ğŸ“¦ *Kutu & Ã–zel Pet Drop*
â€¢ Kutu aÃ§tÄ±ÄŸÄ±nda:
  - Ã‡ip
  - Pet bonuslu ekstra kazanÃ§
  - Etkinlik buffâ€™Ä± varsa ekstra buff kazancÄ±
  - Nadir ihtimalle *kristal* ve *Ã¶zel petler* kazanÄ±rsÄ±n.

â€¢ Ã–zel pet Ã¶rnekleri:
  - ğŸ¢ KaplumbaÄŸa (koleksiyon)
  - ğŸŒ Salyangoz (hunt drop ÅŸansÄ±)
  - ğŸ¨ Koala (30 dakikada bir pasif Ã§ip geliri)
â€¢ AyrÄ±ca bir *pity sistemi* vardÄ±r:
  - Ã‡ok fazla kutu aÃ§Ä±p hiÃ§ Ã¶zel pet almamÄ±ÅŸsan,
    sistem bir noktadan sonra garanti Ã¶zel pet verebilir.

ğŸ“œ *GÃ¼nlÃ¼k GÃ¶revler*
â€¢ .gÃ¶rev â€” BugÃ¼ne Ã¶zel rastgele gÃ¶revler:
  - Slot oyna, blackjack oyna, hunt yap, kutu aÃ§, gÃ¼nlÃ¼k Ã¶dÃ¼l al gibi
â€¢ GÃ¶revler bitince otomatik Ã§ip Ã¶dÃ¼lÃ¼ gelir.

ğŸ– *Unvan Sistemi*
â€¢ OynadÄ±kÃ§a sistem seni takip eder ve otomatik unvan aÃ§arsÄ±n:
  - ğŸ†• Yeni MaceracÄ±
  - ğŸ’° Zengin Oyuncu
  - ğŸ° Slot UstasÄ±
  - ğŸ¡ Rulet UstasÄ±
  - ğŸƒ Blackjack Efsanesi
  - ğŸª¶ Yeni AvcÄ± / ğŸ¦´ Usta AvcÄ±
  - ğŸ Kutu Delisi
  - ğŸ¾ Pet Sahibi
  - ğŸ“… SadÄ±k Oyuncu
  - ğŸŒ€ OwO Efsanesi (birÃ§ok unvan aÃ§Ä±nca)
  - ğŸ‘‘ Sunucu Lordu (adminâ€™e Ã¶zel)

â€¢ .unvan â€” UnvanlarÄ±nÄ± listele
â€¢ .unvan set <numara> â€” Aktif unvanÄ±nÄ± seÃ§

ğŸ‘‘ *YÃ¶netici Ã–zel*
â€¢ .pet adminkurt â†’ Adminâ€™e Ã¶zel Alfa Kurt peti (ATK/LUCK 999)
â€¢ .unvan admin â†’ Adminâ€™e Ã¶zel Sunucu Lordu unvanÄ±
â€¢ Adminâ€™e Ã¶zel profil temasÄ± (tema maÄŸazasÄ±nda adminOnly)
â€¢ .eventbuff â†’ Hunt & kutu gelirlerini ve kristal drop oranÄ±nÄ± geÃ§ici olarak bufflar
â€¢ .allpman / .alpman / .max / .listedenat vb. yÃ¶netici ekonomi & moderasyon komutlarÄ±

ğŸ’¡ *GÃ¼nlÃ¼k Rutin Ã–nerisi*
1) .join  (bir kereye mahsus)
2) .gÃ¼nlÃ¼k  (her gÃ¼n Ã§ip al)
3) .hunt / .slot / .rulet / .bj ile oyna
4) .kutu veya .kutu all ile kutularÄ± aÃ§
5) .kristal ile Ã¶zel ÅŸeyler biriktir
6) .profilskin liste â†’ hoÅŸuna giden temayÄ± al, set et
7) .unvan ile havalÄ± unvanÄ±nÄ± seÃ§
8) .pet al / .pet shop / .pets ile koleksiyonunu bÃ¼yÃ¼t ğŸ˜`;
